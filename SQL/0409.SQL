/*
** NOTA FISCAL
*/

SET TERM ^ ;

CREATE PROCEDURE IMPNOTA_LINHA (
    NUMIMPNOTA INTEGER,
    OFFSET INTEGER)
AS
DECLARE VARIABLE LINHA INTEGER;
BEGIN

  FOR
  SELECT
    LINHA
  FROM
    ITIMPNOTA
  WHERE
    NUMIMPNOTA = :NUMIMPNOTA
  ORDER BY
    LINHA DESC
  INTO
    :LINHA
  DO
  BEGIN

    UPDATE
      ITIMPNOTA
    SET
      LINHA = LINHA + :OFFSET
    WHERE
      NUMIMPNOTA = :NUMIMPNOTA AND
      LINHA = :LINHA;

  END

END
^

SET TERM ; ^

GRANT EXECUTE ON PROCEDURE IMPNOTA_LINHA TO PUBLIC;

SET TERM ^ ;

ALTER PROCEDURE IMPNOTA_LINHA (
    NUMIMPNOTA INTEGER,
    OFFSET INTEGER,
    INICIO INTEGER,
    FIM INTEGER)
AS
DECLARE VARIABLE LINHA INTEGER;
BEGIN

  IF (OFFSET < 0) THEN
   BEGIN

     FOR
     SELECT
       LINHA
     FROM
       ITIMPNOTA
     WHERE
       NUMIMPNOTA = :NUMIMPNOTA AND
       LINHA BETWEEN :INICIO AND :FIM
     ORDER BY
       LINHA
     INTO
       :LINHA
     DO
     BEGIN

       UPDATE
         ITIMPNOTA
       SET
         LINHA = LINHA + :OFFSET
       WHERE
         NUMIMPNOTA = :NUMIMPNOTA AND
         LINHA = :LINHA;

     END

   END ELSE
   BEGIN

     FOR
     SELECT
       LINHA
     FROM
       ITIMPNOTA
     WHERE
       NUMIMPNOTA = :NUMIMPNOTA AND
       LINHA BETWEEN :INICIO AND :FIM
     ORDER BY
       LINHA DESC
     INTO
       :LINHA
     DO
     BEGIN

       UPDATE
         ITIMPNOTA
       SET
         LINHA = LINHA + :OFFSET
       WHERE
         NUMIMPNOTA = :NUMIMPNOTA AND
         LINHA = :LINHA;

     END

   END

END
^

SET TERM ; ^

INSERT INTO SCRIPTVER(NUMERO, DATA) VALUES (409, CURRENT_TIMESTAMP);
COMMIT;
