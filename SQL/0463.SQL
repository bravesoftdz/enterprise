/*
** CANCELA O RG DA PESSOA FISICA NA EMISSAO DE NFE
*/

SET TERM ^ ;

CREATE OR ALTER procedure REL_NOTACORPO (
    CODMOVIMENTO integer)
returns (
    ES smallint,
    CODCLIENTE integer,
    DATA timestamp,
    SERVICOS varchar(254),
    VALOR_SERVICOS numeric(9,2),
    VALOR_ITENS numeric(9,2),
    DESCONTO numeric(9,2),
    VALOR_PRODUTOS numeric(9,2),
    VALOR_ICMS numeric(9,2),
    VALOR_TOTAL numeric(9,2),
    OBSERVACOES varchar(254),
    NOTA_NUMERO integer,
    NOTA_DATAEMISSAO timestamp,
    NOTA_CODNATUOPER varchar(10),
    NOTA_CODTRANSPORTADOR integer,
    NOTA_PLACAVEICULO varchar(10),
    NOTA_UFVEICULO varchar(2),
    NOTA_FRETE smallint,
    NOTA_VALOR_FRETE numeric(9,2),
    NOTA_VALOR_SEGURO numeric(9,2),
    NOTA_VALOR_OUTROS numeric(9,2),
    NOTA_VALOR_TOTAL numeric(9,2),
    NOTA_QUANTIDADE numeric(9,2),
    NOTA_ESPECIE varchar(30),
    NOTA_MARCA varchar(20),
    NOTA_VOLNUM integer,
    NOTA_PESOBRUTO numeric(9,2),
    NOTA_PESOLIQUIDO numeric(9,2),
    NOTA_DADOSADICIONAIS varchar(254),
    CODVENDEDOR integer,
    STATUS varchar(30),
    CONDICAO varchar(40),
    DATAINICIO timestamp,
    DATATERMINO timestamp,
    ICMSSIMPLES char(1),
    ICMSSIMPALIQ numeric(9,4),
    ISSALIQ numeric(9,4),
    VALOR_ISS numeric(9,2),
    NOTA_IESUBST varchar(20),
    NOTA_DATASAIDA timestamp,
    NOTA_BASEICMS numeric(9,4),
    NOTA_BASEICMSSUBST numeric(9,4),
    NOTA_VALORICMSSUBST numeric(9,2),
    VALOR_IPI numeric(9,2),
    CODVENDEDOR_ABRE integer,
    DESCONTOTXT varchar(40),
    CLI_NOME varchar(40),
    CLI_RAZAOSOCIAL varchar(40),
    CLI_LOGRADOURO varchar(60),
    CLI_NUMERO integer,
    CLI_COMPLEMENTO varchar(40),
    CLI_BAIRRO varchar(60),
    CLI_CEP varchar(10),
    CLI_CIDADE varchar(60),
    CLI_ESTADO varchar(2),
    CLI_FONE varchar(20),
    CLI_FAX varchar(20),
    CLI_CELULAR varchar(20),
    CLI_EMAIL varchar(50),
    CLI_RGIE varchar(20),
    CLI_CPFCGC varchar(20),
    CLI_MUNIBGE varchar(10),
    TRA_NOME varchar(40),
    TRA_LOGRADOURO varchar(60),
    TRA_NUMERO integer,
    TRA_COMPLEMENTO varchar(40),
    TRA_BAIRRO varchar(60),
    TRA_CEP varchar(10),
    TRA_CIDADE varchar(60),
    TRA_ESTADO varchar(2),
    TRA_FONE varchar(20),
    TRA_FAX varchar(20),
    TRA_EMAIL varchar(50),
    TRA_RGIE varchar(20),
    TRA_CPFCGC varchar(20),
    TRA_MUNIBGE varchar(10),
    CODIGO integer,
    MARCA varchar(40),
    MODELO varchar(40),
    DEFEITO varchar(40),
    GARANTIA char(1),
    SERIE varchar(40),
    ACESSORIOS varchar(50),
    CONDICAOEXTERNA varchar(40),
    SOLICITANTE varchar(40),
    VENDEDORABRE varchar(40),
    VENDEDOR varchar(40),
    USUARIO varchar(40),
    CLI_CONTRATO char(1),
    CLI_KM integer,
    NATUREZAOPERACAO varchar(30),
    CODEMPRESA integer,
    EMPRESA_NOME varchar(40),
    EMPRESA_RAZAOSOCIAL varchar(50),
    EMPRESA_CNPJ varchar(20),
    EMPRESA_IE varchar(20),
    EMPRESA_LOGRADOURO varchar(60),
    EMPRESA_NUMERO integer,
    EMPRESA_COMPLEMENTO varchar(40),
    EMPRESA_BAIRRO varchar(60),
    EMPRESA_CIDADE varchar(60),
    EMPRESA_ESTADO char(2),
    EMPRESA_CEP varchar(9),
    EMPRESA_FONE varchar(20),
    EMPRESA_MUNIBGE varchar(10),
    EMPRESA_CNAE varchar(10),
    EMPRESA_IM varchar(20),
    TIPOOS varchar(40),
    XX_ENTRADA char(2),
    XX_SAIDA char(2),
    EXTENSO varchar(254),
    TECNICO varchar(20),
    DEFEITO_DETECTADO varchar(60),
    SERVICO_REALIZAR varchar(60),
    AUTORIZADO char(1),
    DATA_AUTORIZADO timestamp,
    QUEM_AUTORIZOU varchar(40),
    DATA_ENTREGA timestamp,
    QUEM_ENTREGOU varchar(40),
    QUEM_RECEBEU varchar(40),
    NOTA_ENTRADA integer,
    AUTORIZADO_SIM char(1),
    AUTORIZADO_NAO char(1),
    PARCEIRO varchar(40),
    MENSAGEM_OS varchar(254),
    MENSAGEM_VENDA varchar(254),
    OPERADORA varchar(40),
    NO_IPI char(1),
    TOTAL_TRIBUTADO numeric(14,3),
    TOTAL_CREDITOICMS numeric(14,3),
    ALIQUOTA_ICMSSIMPLES numeric(9,4),
    TIPODOC char(3))
as
declare variable TEMP_PESSOAFISICA char(1);
declare variable TEMP_RAZAOSOCIAL varchar(40);
declare variable TEMP_IE varchar(20);
declare variable TEMP_CGC varchar(20);
declare variable CODMARCA integer;
declare variable CODMODELO integer;
declare variable CODDEFEITO integer;
declare variable OSTIPO integer;
declare variable MAXTECNICO integer;
declare variable CODPARCEIRO integer;
declare variable SITUACAOTRIBUTARIA char(3);
declare variable VALORDOITEM numeric(14,3);
BEGIN
  SELECT
    CODIGO,
    ES,
    CODCLIENTE,
    DATA,
    UDF_LEFT(SERVICOS, 254),
    VALOR_SERVICOS,
    VALOR_ITENS,
    DESCONTO,
    VALOR_PRODUTOS,
    VALOR_ICMS,
    VALOR_TOTAL,
    UDF_LEFT(OBSERVACOES, 254),
    NOTA_NUMERO,
    NOTA_DATAEMISSAO,
    NOTA_CODNATUOPER,
    NOTA_CODTRANSPORTADOR,
    NOTA_PLACAVEICULO,
    NOTA_UFVEICULO,
    NOTA_FRETE,
    NOTA_VALOR_FRETE,
    NOTA_VALOR_SEGURO,
    NOTA_VALOR_OUTROS,
    NOTA_VALOR_TOTAL,
    NOTA_QUANTIDADE,
    NOTA_ESPECIE,
    NOTA_MARCA,
    NOTA_VOLNUM,
    NOTA_PESOBRUTO,
    NOTA_PESOLIQUIDO,
    UDF_LEFT(NOTA_DADOSADICIONAIS, 254),
    CODVENDEDOR,
    STATUS,
    CONDICAO,
    DATAINICIO,
    DATATERMINO,
    ICMSSIMPLES,
    ICMSSIMPALIQ,
    ISSALIQ,
    VALOR_ISS,
    NOTA_IESUBST,
    NOTA_DATASAIDA,
    NOTA_BASEICMS,
    NOTA_BASEICMSSUBST,
    NOTA_VALORICMSSUBST,
    VALOR_IPI,
    CODVENDEDOR_ABRE,
    DESCONTOTXT,
    CODMARCA,
    CODMODELO,
    CODDEFEITO,
    GARANTIA,
    SERIE,
    ACESSORIOS,
    CONDICAOEXTERNA,
    SOLICITANTE,
    CODEMPRESA,
    OSTIPO,
    DEFEITO_DETECTADO,
    SERVICO_REALIZAR,
    AUTORIZADO,
    DATA_AUTORIZADO,
    QUEM_AUTORIZOU,
    DATA_ENTREGA,
    QUEM_ENTREGOU,
    QUEM_RECEBEU,
    NOTA_ENTRADA,
    CODPARCEIRO,
    OPERADORA,
    NO_IPI,
    TIPODOC
  FROM
    MOVIMENTOS MO
  WHERE
    CODIGO = :CODMOVIMENTO
  INTO
    :CODIGO,
    :ES,
    :CODCLIENTE,
    :DATA,
    :SERVICOS,
    :VALOR_SERVICOS,
    :VALOR_ITENS,
    :DESCONTO,
    :VALOR_PRODUTOS,
    :VALOR_ICMS,
    :VALOR_TOTAL,
    :OBSERVACOES,
    :NOTA_NUMERO,
    :NOTA_DATAEMISSAO,
    :NOTA_CODNATUOPER,
    :NOTA_CODTRANSPORTADOR,
    :NOTA_PLACAVEICULO,
    :NOTA_UFVEICULO,
    :NOTA_FRETE,
    :NOTA_VALOR_FRETE,
    :NOTA_VALOR_SEGURO,
    :NOTA_VALOR_OUTROS,
    :NOTA_VALOR_TOTAL,
    :NOTA_QUANTIDADE,
    :NOTA_ESPECIE,
    :NOTA_MARCA,
    :NOTA_VOLNUM,
    :NOTA_PESOBRUTO,
    :NOTA_PESOLIQUIDO,
    :NOTA_DADOSADICIONAIS,
    :CODVENDEDOR,
    :STATUS,
    :CONDICAO,
    :DATAINICIO,
    :DATATERMINO,
    :ICMSSIMPLES,
    :ICMSSIMPALIQ,
    :ISSALIQ,
    :VALOR_ISS,
    :NOTA_IESUBST,
    :NOTA_DATASAIDA,
    :NOTA_BASEICMS,
    :NOTA_BASEICMSSUBST,
    :NOTA_VALORICMSSUBST,
    :VALOR_IPI,
    :CODVENDEDOR_ABRE,
    :DESCONTOTXT,
    :CODMARCA,
    :CODMODELO,
    :CODDEFEITO,
    :GARANTIA,
    :SERIE,
    :ACESSORIOS,
    :CONDICAOEXTERNA,
    :SOLICITANTE,
    :CODEMPRESA,
    :OSTIPO,
    :DEFEITO_DETECTADO,
    :SERVICO_REALIZAR,
    :AUTORIZADO,
    :DATA_AUTORIZADO,
    :QUEM_AUTORIZOU,
    :DATA_ENTREGA,
    :QUEM_ENTREGOU,
    :QUEM_RECEBEU,
    :NOTA_ENTRADA,
    :CODPARCEIRO,
    :OPERADORA,
    :NO_IPI,
    :TIPODOC;

  SELECT
    CL.NOME,
    UDF_LEFT(CL.RAZAOSOCIAL, 40),
    CL.PESSOAFISICA,
    CL.NUMERO,
    CL.COMPLEMENTO,
    CL.ESTADO,
    CL.FONE,
    CL.FAX,
    CL.CELULAR,
    CL.EMAIL,
    CL.RG,
    CL.CPF,
    CL.IE,
    CL.CGC,
    CL.CONTRATO,
    CL.KMS,
    CL.LOGRADOURO,
    CL.BAIRRO,
    CL.CIDADE,
    CL.CEP,
    CL.MUNIBGE
  FROM
    CLIENTES CL
  WHERE
    CL.CODIGO = :CODCLIENTE
  INTO
    :CLI_NOME,
    :TEMP_RAZAOSOCIAL,
    :TEMP_PESSOAFISICA,
    :CLI_NUMERO,
    :CLI_COMPLEMENTO,
    :CLI_ESTADO,
    :CLI_FONE,
    :CLI_FAX,
    :CLI_CELULAR,
    :CLI_EMAIL,
    :CLI_RGIE,
    :CLI_CPFCGC,
    :TEMP_IE,
    :TEMP_CGC,
    :CLI_CONTRATO,
    :CLI_KM,
    :CLI_LOGRADOURO,
    :CLI_BAIRRO,
    :CLI_CIDADE,
    :CLI_CEP,
    :CLI_MUNIBGE;

  IF ( TEMP_PESSOAFISICA = 'J' ) THEN
   BEGIN
     CLI_RGIE        = TEMP_IE;
     CLI_CPFCGC      = TEMP_CGC;
     CLI_RAZAOSOCIAL = TEMP_RAZAOSOCIAL;
   END ELSE
   BEGIN
     CLI_RAZAOSOCIAL = CLI_NOME;
     CLI_RGIE        = '';
   END

  TEMP_PESSOAFISICA = '';
  TEMP_IE           = '';
  TEMP_CGC          = '';
  TEMP_RAZAOSOCIAL  = '';

  SELECT
    TR.NOME,
    UDF_LEFT(TR.RAZAOSOCIAL, 40),
    TR.PESSOAFISICA,
    TR.NUMERO,
    TR.COMPLEMENTO,
    TR.ESTADO,
    TR.FONE,
    TR.FAX,
    TR.EMAIL,
    TR.RG,
    TR.CPF,
    TR.IE,
    TR.CGC,
    TR.LOGRADOURO,
    TR.BAIRRO,
    TR.CIDADE,
    TR.CEP,
    TR.MUNIBGE
  FROM
    CLIENTES TR
  WHERE
    TR.CODIGO = :NOTA_CODTRANSPORTADOR
  INTO
    :TRA_NOME,
    :TEMP_RAZAOSOCIAL,
    :TEMP_PESSOAFISICA,
    :TRA_NUMERO,
    :TRA_COMPLEMENTO,
    :TRA_ESTADO,
    :TRA_FONE,
    :TRA_FAX,
    :TRA_EMAIL,
    :TRA_RGIE,
    :TRA_CPFCGC,
    :TEMP_IE,
    :TEMP_CGC,
    :TRA_LOGRADOURO,
    :TRA_BAIRRO,
    :TRA_CIDADE,
    :TRA_CEP,
    :TRA_MUNIBGE;

  IF ( TEMP_PESSOAFISICA = 'J' ) THEN
   BEGIN
     TRA_RGIE   = TEMP_IE;
     TRA_CPFCGC = TEMP_CGC;
   END

  SELECT
    NOME
  FROM
    CLIENTES
  WHERE
    CODIGO = :CODVENDEDOR_ABRE
  INTO
    :VENDEDORABRE;

  SELECT
    NOME
  FROM
    CLIENTES
  WHERE
    CODIGO = :CODVENDEDOR
  INTO
    :VENDEDOR;

  SELECT
    DESCRICAO
  FROM
    MARCAS
  WHERE
    CODIGO = :CODMARCA
  INTO
    :MARCA;

  SELECT
    DESCRICAO
  FROM
    MODELOS
  WHERE
    CODIGO = :CODMODELO AND
    CODEQUIPAMENTO = :CODMARCA
  INTO
    :MODELO;

  SELECT
    DESCRICAO
  FROM
    DEFEITOS
  WHERE
    CODIGO = :CODDEFEITO
  INTO
    :DEFEITO;

  SELECT
    NATUREZA
  FROM
    NATUOPER
  WHERE
    CODIGO = :NOTA_CODNATUOPER
  INTO
    :NATUREZAOPERACAO;

  SELECT
    TIPO
  FROM
    OSTIPOS
  WHERE
    CODIGO = :OSTIPO
  INTO
    :TIPOOS;

  SELECT
    CL.NOME,
    CL.RAZAOSOCIAL,
    CL.CGC,
    CL.IE,
    CL.LOGRADOURO,
    CL.NUMERO,
    CL.COMPLEMENTO,
    CL.BAIRRO,
    CL.CIDADE,
    CL.ESTADO,
    CL.CEP,
    CL.FONE,
    CL.MUNIBGE,
    CL.CNAE,
    CL.IM,
    SI.MENSAGEM_OS,
    SI.MENSAGEM_VENDA,
    SI.ALIQUOTA_ICMSSIMPLES
  FROM
    SISCONFIG SI
    JOIN CLIENTES CL ON
      (SI.CODCLIENTE = CL.CODIGO)
  WHERE
    SI.CODIGO = :CODEMPRESA
  INTO
    :EMPRESA_NOME,
    :EMPRESA_RAZAOSOCIAL,
    :EMPRESA_CNPJ,
    :EMPRESA_IE,
    :EMPRESA_LOGRADOURO,
    :EMPRESA_NUMERO,
    :EMPRESA_COMPLEMENTO,
    :EMPRESA_BAIRRO,
    :EMPRESA_CIDADE,
    :EMPRESA_ESTADO,
    :EMPRESA_CEP,
    :EMPRESA_FONE,
    :EMPRESA_MUNIBGE,
    :EMPRESA_CNAE,
    :EMPRESA_IM,
    :MENSAGEM_OS,
    :MENSAGEM_VENDA,
    :ALIQUOTA_ICMSSIMPLES;

  USUARIO = USER;

  IF (ES = 1) THEN
   BEGIN

     XX_ENTRADA = 'XX';
     XX_SAIDA   = '  ';

   END ELSE
   BEGIN

     XX_ENTRADA = '  ';
     XX_SAIDA   = 'XX';

   END

  SELECT
    EXTENSO
  FROM
    MOEDAEXTENSO(
       CAST(:NOTA_VALOR_TOTAL AS DOUBLE PRECISION),
       :CODEMPRESA
    )
  INTO
    :EXTENSO;

 SELECT
   MIN(OS.CODVENDEDOR)
 FROM
   OS_VENDER OS
 WHERE
   OS.CODMOVIMENTO = :CODMOVIMENTO
 INTO
   :MAXTECNICO;

 SELECT
   UDF_LEFT(CL.NOME, 20)
 FROM
   CLIENTES CL
 WHERE
   CL.CODIGO = :MAXTECNICO
 INTO
   :TECNICO;

 AUTORIZADO_SIM = ' ';
 AUTORIZADO_NAO = ' ';

 IF (DATA_AUTORIZADO IS NOT NULL) THEN
  BEGIN
    IF (AUTORIZADO = 'S') THEN
      AUTORIZADO_SIM = 'X';
    ELSE
      AUTORIZADO_NAO = 'X';
  END

 SELECT
   NOME
 FROM
   CLIENTES
 WHERE
   CODIGO = :CODPARCEIRO
 INTO
   :PARCEIRO;

 IF (NO_IPI = 'S') THEN
  BEGIN

    SELECT
      SUM(VALOR_IPI)
    FROM
      REL_NOTAPRO(:CODMOVIMENTO)
    INTO
      :VALOR_IPI;

    IF (VALOR_IPI IS NULL) THEN
      VALOR_IPI = 0;

    NOTA_VALOR_TOTAL = NOTA_VALOR_TOTAL + VALOR_IPI;

  END

  /* TOTAL A SER TRIBUTADO */
  TOTAL_TRIBUTADO = 0;
  FOR
  SELECT
    SITTRIBU,
    VALOR_PAGO
  FROM
    REL_NOTAPRO(:CODMOVIMENTO)
  INTO
    :SITUACAOTRIBUTARIA,
    :VALORDOITEM
  DO
  BEGIN
    IF ((SITUACAOTRIBUTARIA = '060') OR (SITUACAOTRIBUTARIA = '160') OR (SITUACAOTRIBUTARIA = '260')) THEN
      TOTAL_TRIBUTADO = TOTAL_TRIBUTADO + VALORDOITEM;
  END
  TOTAL_CREDITOICMS = TOTAL_TRIBUTADO * (ALIQUOTA_ICMSSIMPLES / 100);

 SUSPEND;
END
^

SET TERM ; ^



INSERT INTO SCRIPTVER(NUMERO, DATA) VALUES (463, CURRENT_TIMESTAMP);
COMMIT;