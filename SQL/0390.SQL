/*
** PREÇO DE PRODUTOS POR CLIENTE
*/

CREATE TABLE CLI_PRECOS (
    CODCLIENTE INTEIRO_VALIDO NOT NULL,
    CODPRODUTO INTEIRO_VALIDO NOT NULL,
    PRECO DINHEIRO);

ALTER TABLE CLI_PRECOS
ADD CONSTRAINT PK_CLI_PRECOS
PRIMARY KEY (CODCLIENTE,CODPRODUTO);

GRANT ALL ON CLI_PRECOS TO PUBLIC;

ALTER TABLE CLI_PRECOS
ADD CONSTRAINT FK_CLI_PRECOS_1
FOREIGN KEY (CODCLIENTE)
REFERENCES CLIENTES(CODIGO)
ON DELETE CASCADE
ON UPDATE CASCADE;

ALTER TABLE CLI_PRECOS
ADD CONSTRAINT FK_CLI_PRECOS_3
FOREIGN KEY (CODPRODUTO)
REFERENCES PRODUTOS(CODIGO)
ON DELETE CASCADE
ON UPDATE CASCADE;

--INSERT INTO
--  CLI_PRECOS
--SELECT
--  CLIENTES.CODIGO,
--  PRODUTOS.CODIGO,
--  PRODUTOS.PRECOVENDA
--FROM
--  CLIENTES,
--  PRODUTOS;
  
SET TERM ^ ;

CREATE TRIGGER PRODUTOS_AI0 FOR PRODUTOS
ACTIVE AFTER INSERT POSITION 0
AS
DECLARE VARIABLE CODCLIENTE INTEGER;
BEGIN
  FOR
  SELECT
    CODIGO
  FROM
    CLIENTES
  INTO
    :CODCLIENTE
  DO
  BEGIN

    INSERT INTO
      CLI_PRECOS(
        CODCLIENTE,
        CODPRODUTO,
        PRECO)
      VALUES (
        :CODCLIENTE,
        NEW.CODIGO, 
        NEW.PRECOVENDA);

  END
END
^

SET TERM ; ^

SET TERM ^ ;

CREATE TRIGGER CLIENTES_AI0 FOR CLIENTES
ACTIVE AFTER INSERT POSITION 0
AS
DECLARE VARIABLE CODPRODUTO INTEGER;
DECLARE VARIABLE PRECO NUMERIC(9, 2);
BEGIN
  FOR
  SELECT
    CODIGO,
    PRECOVENDA
  FROM
    PRODUTOS
  INTO
    :CODPRODUTO,
    :PRECO
  DO
  BEGIN

    INSERT INTO
      CLI_PRECOS(
        CODCLIENTE,
        CODPRODUTO,
        PRECO)
      VALUES(
        NEW.CODIGO,
        :CODPRODUTO,
        :PRECO);

  END

END
^

SET TERM ; ^

ALTER TABLE SISCONFIG ADD PRECO_CLIENTE SIMNAO;

UPDATE SISCONFIG SET PRECO_CLIENTE = 'N';

INSERT INTO SCRIPTVER(NUMERO, DATA) VALUES (390, CURRENT_TIMESTAMP);
COMMIT;
