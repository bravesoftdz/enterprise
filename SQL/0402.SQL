/*
** MARGENS DE CONTRIBUIÇÃO DOS PREÇOS ADICIONAIS
*/

SET TERM ^ ;

ALTER TRIGGER PRODUTOS_MARGEM_UPD
INACTIVE BEFORE UPDATE POSITION 200
AS
BEGIN

  IF (NEW.CAIXA_ITENS IS NULL) THEN
    NEW.CAIXA_ITENS = 1;

  /* MARGEM */
  IF ((NEW.PRECOCUSTO = 0) AND (NEW.PRECOVENDA = 0)) THEN
   BEGIN

    NEW.MARGEM = 0;

   END ELSE
   BEGIN

     IF ((NEW.PRECOCUSTO = 0) AND (NEW.PRECOVENDA > 0)) THEN
      BEGIN

        NEW.MARGEM = NEW.PRECOVENDA * 100;

      END ELSE
      BEGIN

        NEW.MARGEM = (100 - ((NEW.PRECOVENDA * 100) / NEW.PRECOCUSTO)) * -1;

      END
   END

  /* MARGEM 2 */
  IF ((NEW.PRECOCUSTO = 0) AND (NEW.PRECOVENDA2 = 0)) THEN
   BEGIN

    NEW.MARGEM2 = 0;

   END ELSE
   BEGIN

     IF ((NEW.PRECOCUSTO = 0) AND (NEW.PRECOVENDA2 > 0)) THEN
      BEGIN

        NEW.MARGEM2 = NEW.PRECOVENDA2 * 100;

      END ELSE
      BEGIN

        NEW.MARGEM2 = (100 - ((NEW.PRECOVENDA2 * 100) / NEW.PRECOCUSTO)) * -1;

      END
   END

  /* MARGEM 3 */
  IF ((NEW.PRECOCUSTO = 0) AND (NEW.PRECOVENDA3 = 0)) THEN
   BEGIN

    NEW.MARGEM3 = 0;

   END ELSE
   BEGIN

     IF ((NEW.PRECOCUSTO = 0) AND (NEW.PRECOVENDA3 > 0)) THEN
      BEGIN

        NEW.MARGEM3 = NEW.PRECOVENDA3 * 100;

      END ELSE
      BEGIN

        NEW.MARGEM3 = (100 - ((NEW.PRECOVENDA3 * 100) / NEW.PRECOCUSTO)) * -1;

      END
   END

   IF (NEW.CODSERVICO IS NULL) THEN
    BEGIN

       NEW.PRECOSERVICO = 0;
       NEW.PRECOTOTAL   = NEW.PRECOVENDA;

    END ELSE NEW.PRECOTOTAL = NEW.PRECOSERVICO + NEW.PRECOVENDA;

END
^

SET TERM ; ^

ALTER TABLE PRODUTOS ADD MARGEM2 PORCENTO;

UPDATE PRODUTOS SET MARGEM2 = 0;

ALTER TABLE PRODUTOS ADD MARGEM3 PORCENTO;

UPDATE PRODUTOS SET MARGEM3 = 0;

SET TERM ^ ;

ALTER TRIGGER PRODUTOS_MARGEM_INS
ACTIVE BEFORE INSERT POSITION 200
AS
BEGIN

  IF (NEW.CAIXA_ITENS IS NULL) THEN
    NEW.CAIXA_ITENS = 1;

  /* MARGEM */
  IF ((NEW.PRECOCUSTO = 0) AND (NEW.PRECOVENDA = 0)) THEN
   BEGIN

    NEW.MARGEM = 0;

   END ELSE
   BEGIN

     IF ((NEW.PRECOCUSTO = 0) AND (NEW.PRECOVENDA > 0)) THEN
      BEGIN

        NEW.MARGEM = NEW.PRECOVENDA * 100;

      END ELSE
      BEGIN

        NEW.MARGEM = (100 - ((NEW.PRECOVENDA * 100) / NEW.PRECOCUSTO)) * -1;

      END
   END

  /* MARGEM 2 */
  IF ((NEW.PRECOCUSTO = 0) AND (NEW.PRECOVENDA2 = 0)) THEN
   BEGIN

    NEW.MARGEM2 = 0;

   END ELSE
   BEGIN

     IF ((NEW.PRECOCUSTO = 0) AND (NEW.PRECOVENDA2 > 0)) THEN
      BEGIN

        NEW.MARGEM2 = NEW.PRECOVENDA2 * 100;

      END ELSE
      BEGIN

        NEW.MARGEM2 = (100 - ((NEW.PRECOVENDA2 * 100) / NEW.PRECOCUSTO)) * -1;

      END
   END

  /* MARGEM 3 */
  IF ((NEW.PRECOCUSTO = 0) AND (NEW.PRECOVENDA3 = 0)) THEN
   BEGIN

    NEW.MARGEM3 = 0;

   END ELSE
   BEGIN

     IF ((NEW.PRECOCUSTO = 0) AND (NEW.PRECOVENDA3 > 0)) THEN
      BEGIN

        NEW.MARGEM3 = NEW.PRECOVENDA3 * 100;

      END ELSE
      BEGIN

        NEW.MARGEM3 = (100 - ((NEW.PRECOVENDA3 * 100) / NEW.PRECOCUSTO)) * -1;

      END
   END

   IF (NEW.CODSERVICO IS NULL) THEN
    BEGIN

       NEW.PRECOSERVICO = 0;
       NEW.PRECOTOTAL   = NEW.PRECOVENDA;

    END ELSE NEW.PRECOTOTAL = NEW.PRECOSERVICO + NEW.PRECOVENDA;
END
^

SET TERM ; ^

SET TERM ^ ;

ALTER TRIGGER PRODUTOS_MARGEM_UPD
ACTIVE BEFORE UPDATE POSITION 200
AS
BEGIN

  IF (NEW.CAIXA_ITENS IS NULL) THEN
    NEW.CAIXA_ITENS = 1;

  /* MARGEM */
  IF ((NEW.PRECOCUSTO = 0) AND (NEW.PRECOVENDA = 0)) THEN
   BEGIN

    NEW.MARGEM = 0;

   END ELSE
   BEGIN

     IF ((NEW.PRECOCUSTO = 0) AND (NEW.PRECOVENDA > 0)) THEN
      BEGIN

        NEW.MARGEM = NEW.PRECOVENDA * 100;

      END ELSE
      BEGIN

        NEW.MARGEM = (100 - ((NEW.PRECOVENDA * 100) / NEW.PRECOCUSTO)) * -1;

      END
   END

  /* MARGEM 2 */
  IF ((NEW.PRECOCUSTO = 0) AND (NEW.PRECOVENDA2 = 0)) THEN
   BEGIN

    NEW.MARGEM2 = 0;

   END ELSE
   BEGIN

     IF ((NEW.PRECOCUSTO = 0) AND (NEW.PRECOVENDA2 > 0)) THEN
      BEGIN

        NEW.MARGEM2 = NEW.PRECOVENDA2 * 100;

      END ELSE
      BEGIN

        NEW.MARGEM2 = (100 - ((NEW.PRECOVENDA2 * 100) / NEW.PRECOCUSTO)) * -1;

      END
   END

  /* MARGEM 3 */
  IF ((NEW.PRECOCUSTO = 0) AND (NEW.PRECOVENDA3 = 0)) THEN
   BEGIN

    NEW.MARGEM3 = 0;

   END ELSE
   BEGIN

     IF ((NEW.PRECOCUSTO = 0) AND (NEW.PRECOVENDA3 > 0)) THEN
      BEGIN

        NEW.MARGEM3 = NEW.PRECOVENDA3 * 100;

      END ELSE
      BEGIN

        NEW.MARGEM3 = (100 - ((NEW.PRECOVENDA3 * 100) / NEW.PRECOCUSTO)) * -1;

      END
   END

   IF (NEW.CODSERVICO IS NULL) THEN
    BEGIN

       NEW.PRECOSERVICO = 0;
       NEW.PRECOTOTAL   = NEW.PRECOVENDA;

    END ELSE NEW.PRECOTOTAL = NEW.PRECOSERVICO + NEW.PRECOVENDA;

END
^

SET TERM ; ^

INSERT INTO SCRIPTVER(NUMERO, DATA) VALUES (402, CURRENT_TIMESTAMP);
COMMIT;
