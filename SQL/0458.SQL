/*
** CHAVE DA NFE
*/

ALTER TABLE MOVIMENTOS ADD CHNFE STR50;

SET TERM ^ ;

CREATE OR ALTER procedure NF_EMISSAO (
    CODMOVIMENTO integer,
    NOTA_NUMERO integer,
    NOTA_TIPO char(3),
    DATA_EMISSAO timestamp,
    DATA_SAIDA timestamp,
    CHAVE_NFE varchar(50))
as
BEGIN

  /* ATUALIZO O MOVIMENTO */
  UPDATE
    MOVIMENTOS MO
  SET
    MO.NOTA_NUMERO = :NOTA_NUMERO,
    MO.TIPODOC = :NOTA_TIPO,
    MO.NOTA_DATAEMISSAO = :DATA_EMISSAO,
    MO.NOTA_DATASAIDA = :DATA_SAIDA,
    MO.CHNFE = :CHAVE_NFE
  WHERE
    MO.CODIGO = :CODMOVIMENTO;

  /* ATUALIZO OS PAGAMENTOS */
  UPDATE
    PAGAMENTOS PA
  SET
    PA.NUMDOC = :NOTA_NUMERO,
    PA.DATADOC = CAST(:DATA_EMISSAO AS DATE),
    PA.TIPODOC = :NOTA_TIPO
  WHERE
    PA.CODMOVIMENTO = :CODMOVIMENTO;

END
^

SET TERM ; ^

INSERT INTO SCRIPTVER(NUMERO, DATA) VALUES (458, CURRENT_TIMESTAMP);
COMMIT;
