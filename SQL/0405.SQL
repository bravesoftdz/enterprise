/*
** CODIGO COMO TRADUTOR
*/

DROP INDEX TRADUTOR_UI1;

ALTER TABLE PLANCONTAS DROP TRADUTOR;

ALTER TABLE PLANCONTAS ADD FINAL SIMNAO;

SET TERM ^ ;

ALTER TRIGGER PLANCONTAS_BI0
ACTIVE BEFORE INSERT POSITION 0
AS
DECLARE VARIABLE CONTADOR INTEGER;
BEGIN

  /* VERIFICO SE EH RAIZ OU DESCENDENTE */
  IF (NEW.CODPAI = -1) THEN
   BEGIN

     /* RAIZ */
     NEW.CODPLANO = '';

   END ELSE
   BEGIN

     /* DESCENDENTE */
     SELECT
       CODPLANO
     FROM
       PLANCONTAS
     WHERE
       CODIGO = NEW.CODPAI
     INTO
       NEW.CODPLANO;

     NEW.CODPLANO = UDF_TRIM(NEW.CODPLANO) || '.';

   END

  /* LIMITO O TAMANHO DO PLANO */
  IF (UDF_LEN(UDF_TRIM(NEW.CODPLANO)) > 16) THEN
    EXCEPTION PLANO_GRANDE;

  SELECT
    MAX(UDF_RIGHT(UDF_TRIM(CODPLANO), 2))
  FROM
    PLANCONTAS
  WHERE
    CODPAI = NEW.CODPAI
  INTO
    :CONTADOR;

  IF (CONTADOR IS NULL) THEN
    CONTADOR = 0;

  IF (CONTADOR = 0) THEN
    CONTADOR = 1;
  ELSE
    CONTADOR = CONTADOR + 1;

  NEW.CODPLANO = UDF_TRIM(NEW.CODPLANO) || UDF_PADL(CAST
(CONTADOR AS VARCHAR(2)), '0', 2);

  NEW.FINAL = 'S';

END
^

SET TERM ; ^

SET TERM ^ ;

CREATE TRIGGER PLANCONTAS_AI0 FOR PLANCONTAS
ACTIVE AFTER INSERT POSITION 0
AS
DECLARE VARIABLE PAI CHAR(1);
BEGIN

  IF (NEW.FINAL = 'S') THEN
   BEGIN

     SELECT
       FINAL
     FROM
       PLANCONTAS
     WHERE
       CODIGO = NEW.CODPAI
     INTO
       :PAI;

     IF (PAI = 'S') THEN
      BEGIN

        UPDATE
          PLANCONTAS
        SET
          FINAL = 'N'
        WHERE
          CODIGO = NEW.CODPAI;

      END

   END

END
^

SET TERM ; ^

SET TERM ^ ;

CREATE TRIGGER PLANCONTAS_BU0 FOR PLANCONTAS
ACTIVE BEFORE UPDATE POSITION 0
AS
DECLARE VARIABLE CONTADOR INTEGER;
BEGIN

  SELECT
    COUNT(*)
  FROM
    PLANCONTAS
  WHERE
    CODPAI = NEW.CODIGO
  INTO
    :CONTADOR;

  IF (CONTADOR IS NULL) THEN
    CONTADOR = 0;

  IF (CONTADOR = 0) THEN
    NEW.FINAL = 'S';
  ELSE
    NEW.FINAL = 'N';

END
^

SET TERM ; ^

SET TERM ^ ;

CREATE TRIGGER PLANCONTAS_AU0 FOR PLANCONTAS
ACTIVE AFTER UPDATE POSITION 0
AS
BEGIN

  IF ((NEW.FINAL = 'S') AND (OLD.FINAL = 'N')) THEN
   BEGIN

     UPDATE
       PLANCONTAS
     SET
       FINAL = 'N'
     WHERE
       CODIGO = NEW.CODPAI;

   END

END
^

SET TERM ; ^

UPDATE
  PLANCONTAS
SET
  FINAL = 'N';

SET TERM ^ ;

ALTER TRIGGER PLANCONTAS_BD0
ACTIVE BEFORE DELETE POSITION 0
AS
BEGIN

  /* DELETO TODOS OS QUE DEPENDEM DELE */
  DELETE FROM
    PLANCONTAS
  WHERE
    CODPAI = OLD.CODIGO;

END
^

SET TERM ; ^

SET TERM ^ ;

CREATE TRIGGER PLANCONTAS_AD0 FOR PLANCONTAS
ACTIVE AFTER DELETE POSITION 0
AS
DECLARE VARIABLE CONTADOR INTEGER;
BEGIN

  SELECT
    COUNT(*)
  FROM
    PLANCONTAS
  WHERE
    CODIGO = OLD.CODPAI
  INTO
    :CONTADOR;

  IF (CONTADOR IS NULL) THEN
    CONTADOR = 0;

  IF (CONTADOR < 2) THEN
   BEGIN

     UPDATE
       PLANCONTAS
     SET
       FINAL = 'S'
     WHERE
       CODIGO = OLD.CODPAI;

   END

END
^

SET TERM ; ^

INSERT INTO SCRIPTVER(NUMERO, DATA) VALUES (405, CURRENT_TIMESTAMP);
COMMIT;
