/*
** DECONTO ADM NA ATIVAÇÃO
*/

ALTER TABLE INDIVIDUAIS ADD DESCONTO_ADM DINHEIRO_VAZIO;

SET TERM ^ ;

ALTER PROCEDURE ATIVACAO_LER (
    CODMOVIMENTO INTEGER)
RETURNS (
    CODATIVACAO INTEGER,
    CODAPARELHO INTEGER,
    APARELHO VARCHAR(60),
    SERIE VARCHAR(30),
    SERIE2 VARCHAR(30),
    NUMERO VARCHAR(20),
    CODOPERADORA INTEGER,
    CODPLANO INTEGER,
    VALOR1 NUMERIC(9,2),
    VALOR2 NUMERIC(9,2),
    REBATE CHAR(1),
    CONTRATO VARCHAR(10),
    VOUCHER VARCHAR(20),
    TIPOATIVACAO CHAR(1),
    DESCONTO_ADM NUMERIC(9,2))
AS
DECLARE VARIABLE DESCRICAO VARCHAR(60);
BEGIN

  /* APARELHO */
  SELECT FIRST 1
    ID.CODIGO,
    PO.CODIGO,
    ID.APARELO,
    PO.DESCRICAO,
    PO.PRECOVENDA,
    ID.VALOR_PAGO,
    ID.SERIE,
    ID.SERIE2,
    ID.NUMERO_FONE,
    ID.CODOPERADORA,
    ID.CODPLANO,
    ID.CONTRATO,
    ID.VOUCHER,
    ID.TIPOATIVACAO,
    ID.DESCONTO_ADM
  FROM
    INDIVIDUAIS ID
    JOIN PRODUTOS PO ON
      (PO.CODIGO = ID.CODPRODUTO)
    JOIN PRODUTOS SE ON
      (SE.CODIGO = PO.CODSERVICO)
  WHERE
    ID.CODMOVSAIDA = :CODMOVIMENTO AND
    ID.PS = 'P' AND
    ID.VENDIDO = 'S' AND
    ID.UNICO = 1 AND
    SE.ATIVACAO = 'S'
  INTO
    :CODATIVACAO,
    :CODAPARELHO,
    :APARELHO,
    :DESCRICAO,
    :VALOR1,
    :VALOR2,
    :SERIE,
    :SERIE2,
    :NUMERO,
    :CODOPERADORA,
    :CODPLANO,
    :CONTRATO,
    :VOUCHER,
    :TIPOATIVACAO,
    :DESCONTO_ADM;

  IF ((APARELHO IS NULL) AND (DESCRICAO IS NOT NULL)) THEN
    APARELHO = DESCRICAO;

  IF (VALOR1 <> VALOR2) THEN
    REBATE = 'S';
  ELSE
    REBATE = 'N';

  IF (CODATIVACAO IS NOT NULL) THEN
    SUSPEND;

END
^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE ATIVACAO_GRAVAR (
    CODATIVACAO INTEGER,
    CODAPARELHO INTEGER,
    APARELHO VARCHAR(60),
    SERIE VARCHAR(30),
    SERIE2 VARCHAR(30),
    NUMERO VARCHAR(20),
    CODOPERADORA INTEGER,
    CODPLANO INTEGER,
    CONTRATO VARCHAR(10),
    VOUCHER VARCHAR(20),
    TIPOATIVACAO CHAR(1),
    REBATE CHAR(1),
    DESCONTO_ADM NUMERIC(9,2))
AS
BEGIN

  IF (CODATIVACAO IS NOT NULL) THEN
    UPDATE
      INDIVIDUAIS ID
    SET
      ID.CODINDIVIDUO = :CODAPARELHO,
      ID.APARELO      = :APARELHO,
      ID.SERIE        = :SERIE,
      ID.SERIE2       = :SERIE2,
      ID.NUMERO_FONE  = :NUMERO,
      ID.CODOPERADORA = :CODOPERADORA,
      ID.CODPLANO     = :CODPLANO,
      ID.REBATE       = :REBATE,
      ID.CONTRATO     = :CONTRATO,
      ID.VOUCHER      = :VOUCHER,
      ID.TIPOATIVACAO = :TIPOATIVACAO,
      ID.ATIVACAO     = 'S',
      ID.DESCONTO_ADM = :DESCONTO_ADM
    WHERE
      ID.CODIGO       = :CODATIVACAO;

END
^

SET TERM ; ^

INSERT INTO SCRIPTVER(NUMERO, DATA) VALUES (443, CURRENT_TIMESTAMP);
COMMIT;
