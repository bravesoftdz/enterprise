/*
** ATUALIZAÇÃO DA NOTA FISCAL
*/

SET TERM ^ ;

ALTER PROCEDURE NF_EMISSAO (
    CODMOVIMENTO INTEGER)
RETURNS (
    NOTA_NUMERO INTEGER)
AS
BEGIN

  EXECUTE PROCEDURE SEQ_OBTER ('NOTAFISCAL')
    RETURNING_VALUES :NOTA_NUMERO;

  /* ATUALIZO O MOVIMENTO */
  UPDATE
    MOVIMENTOS MO
  SET
    MO.NOTA_NUMERO = :NOTA_NUMERO,
    MO.NOTA_DATAEMISSAO = CURRENT_TIMESTAMP,
    MO.NOTA_DATASAIDA = CURRENT_TIMESTAMP
  WHERE
    MO.CODIGO = :CODMOVIMENTO;

  /* ATUALIZO OS PAGAMENTOS */
  UPDATE
    PAGAMENTOS PA
  SET
    PA.NUMDOC = :NOTA_NUMERO,
    PA.DATADOC = CURRENT_DATE,
    PA.TIPODOC = 'NF'
  WHERE
    PA.CODMOVIMENTO = :CODMOVIMENTO;

END
^

SET TERM ; ^

INSERT INTO SCRIPTVER(NUMERO, DATA) VALUES (407, CURRENT_TIMESTAMP);
COMMIT;
