/*
** ESTOQUE ABAIXO DO MINIMO
*/

SET TERM ^ ;

CREATE OR ALTER PROCEDURE ESTOQUE_MINIMO
RETURNS (
    CODIGO INTEGER,
    BARRA CHAR(14),
    DESCRICAO VARCHAR(60),
    PRECOCUSTO NUMERIC(9,2),
    PRECOVENDA NUMERIC(9,2),
    TOTALCUSTO NUMERIC(9,2),
    TOTALVENDA NUMERIC(9,2),
    LUCRO NUMERIC(9,4),
    OCULTO CHAR(1),
    MINIMO NUMERIC(9,2),
    GRUPO VARCHAR(40),
    QUANTIDADE NUMERIC(9,2),
    TOTALSERVICO NUMERIC(9,2),
    CODEMPRESA INTEGER,
    EMPRESA_NOME VARCHAR(50))
AS
BEGIN

  FOR
  SELECT
    SI.CODIGO,
    CL.NOME
  FROM
    SISCONFIG SI
    LEFT JOIN CLIENTES CL ON
      (CL.CODIGO = SI.CODCLIENTE)
  ORDER BY
    SI.CODIGO
  INTO
    :CODEMPRESA,
    :EMPRESA_NOME
  DO
  BEGIN

    FOR
    SELECT
      PO.CODIGO,
      PO.BARRA,
      PO.DESCRICAO,
      PO.PRECOCUSTO,
      PO.PRECOVENDA,
      CAST(PO.MARGEM AS NUMERIC(9, 4)) AS LUCRO,
      PO.OCULTO,
      PO.MINIMO,
      GU.GRUPO,
      (
         SELECT
           SUM(QUANTIDADE)
         FROM
           INDIVIDUAIS ID
         WHERE
           ID.CODPRODUTO = PO.CODIGO AND
           ID.VENDIDO = 'N' AND
           ID.CODEMPRESA = :CODEMPRESA
      ) AS QUANTIDADE,
      (
         SELECT
           (SE.PRECOVENDA + PO.PRECOVENDA)
         FROM
           PRODUTOS SE
         WHERE
           SE.CODIGO = PO.CODSERVICO AND
           SE.PS = 'S'
       ) AS TOTALSERVICO
    FROM
      PRODUTOS PO
      LEFT JOIN GRUPOS GU ON
        (GU.CODIGO = PO.GRUPO)
    WHERE
      PO.PS = 'P'
    INTO
      :CODIGO,
      :BARRA,
      :DESCRICAO,
      :PRECOCUSTO,
      :PRECOVENDA,
      :LUCRO,
      :OCULTO,
      :MINIMO,
      :GRUPO,
      :QUANTIDADE,
      :TOTALSERVICO
    DO
    BEGIN
      TOTALCUSTO = (PRECOCUSTO * QUANTIDADE);
      TOTALVENDA = (PRECOVENDA * QUANTIDADE);
      IF (QUANTIDADE IS NULL) THEN
        QUANTIDADE = 0;
      IF (QUANTIDADE < MINIMO) THEN
        SUSPEND;
    END

  END
END
^

SET TERM ; ^

INSERT INTO SCRIPTVER(NUMERO, DATA) VALUES (459, CURRENT_TIMESTAMP);
COMMIT;
