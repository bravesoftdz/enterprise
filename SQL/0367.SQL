/*
** APRIMORAMENTO NO BLOQUEIO DE CLIENTES
*/

SET TERM ^ ;

ALTER PROCEDURE VENDA_FECHA (
    CODMOVIMENTO INTEGER,
    USUARIOFECHAMENTO VARCHAR(30),
    OBSERVACOES VARCHAR(254),
    CONDICOES1 VARCHAR(512),
    CONDICOES2 VARCHAR(512),
    OPCIONAIS VARCHAR(512))
RETURNS (
    RE_MOVIMENTO INTEGER)
AS
DECLARE VARIABLE TIPO INTEGER;
DECLARE VARIABLE ES INTEGER;
DECLARE VARIABLE FECHADO CHAR(1);
DECLARE VARIABLE CREDITO NUMERIC(9,2);
DECLARE VARIABLE ABERTOS NUMERIC(9,2);
DECLARE VARIABLE CODCLIENTE INTEGER;
DECLARE VARIABLE CODEMPRESA INTEGER;
DECLARE VARIABLE VERIFICA_LIMITE CHAR(1);
DECLARE VARIABLE PRIMEIRADATA TIMESTAMP;
DECLARE VARIABLE BLOQUEIO_DIAS INTEGER;
BEGIN

  RE_MOVIMENTO = 0;
  FECHADO = 'N';

  /* LEIO O TIPO ATUAL */
  SELECT
    ES,
    TIPO
  FROM
    MOVIMENTOS
  WHERE
    CODIGO = :CODMOVIMENTO
  INTO
    :ES,
    :TIPO;

  IF (TIPO IN (1, 2, 5)) THEN
   BEGIN

     IF ((ES = 1) AND (TIPO = 1)) THEN
       FECHADO = 'S';

     IF ((ES = 2) AND (USUARIOFECHAMENTO > '')) THEN
      BEGIN

        IF (TIPO = 2) THEN
          TIPO = 3;
        ELSE
          TIPO = 6;

        FECHADO = 'S';

        /* VERIFICAÇÃO DE CREDITO */
        IF (TIPO IN (3, 6)) THEN
         BEGIN

           /* LIMITE DE CREDITO */
           SELECT
             CL.LIMITECREDITO,
             CL.CODIGO,
             MO.CODEMPRESA,
             SC.VERIFICA_LIMITE,
             SC.BLOQUEIO_DIAS
           FROM
             CLIENTES CL
             JOIN MOVIMENTOS MO ON
               (MO.CODCLIENTE = CL.CODIGO)
             JOIN SISCONFIG SC ON
               (SC.CODIGO = MO.CODEMPRESA)
           WHERE
             MO.CODIGO = :CODMOVIMENTO
           INTO
             :CREDITO,
             :CODCLIENTE,
             :CODEMPRESA,
             :VERIFICA_LIMITE,
             :BLOQUEIO_DIAS;

           /* TOTAL EM ABERTO */
           SELECT
             SUM(VALOR),
             MIN(DATAVENCIMENTO)
           FROM
             PAGAMENTOS
           WHERE
             PAGO = 0 AND
             ES = 2 AND
             CODEMPRESA = :CODEMPRESA AND
             CODCLIENTE = :CODCLIENTE
           INTO
             :ABERTOS,
             :PRIMEIRADATA;

           IF (VERIFICA_LIMITE = 'S') THEN
            BEGIN

              IF (ABERTOS > CREDITO) THEN
                RE_MOVIMENTO = 2;

            END

           /* DEBITOS NO FINANCEIRO */
           IF ((RE_MOVIMENTO = 0) AND (PRIMEIRADATA IS NOT NULL)) THEN
            BEGIN

              /* DIAS PRARA BLOQUEIO */
              IF (CAST((CURRENT_TIMESTAMP - PRIMEIRADATA) AS INTEGER) > BLOQUEIO_DIAS) THEN
                RE_MOVIMENTO = 3;

            END

         END

      END

     IF (RE_MOVIMENTO = 0) THEN
      BEGIN

        UPDATE
          MOVIMENTOS
        SET
          TIPO = :TIPO,
          USUARIOFECHAMENTO = :USUARIOFECHAMENTO,
          DATAFECHAMENTO = CURRENT_TIMESTAMP,
          OBSERVACOES = :OBSERVACOES,
          CONDICOES1 = :CONDICOES1,
          CONDICOES2 = :CONDICOES2,
          OPCIONAIS = :OPCIONAIS,
          FECHADO = :FECHADO
        WHERE
          CODIGO = :CODMOVIMENTO;

        /*WHEN ANY DO RE_MOVIMENTO = 1;*/

      END

   END

END
^

SET TERM ; ^

INSERT INTO SCRIPTVER(NUMERO, DATA) VALUES (367, CURRENT_TIMESTAMP);
COMMIT;

