/*
** ESTOQUE EM UMA DETERMINADA DATA
*/

SET TERM ^ ;

CREATE OR ALTER PROCEDURE ESTOQUE_DATA (
    DATA DATE,
    CODEMPRESA INTEGER)
RETURNS (
    CODIGO INTEGER,
    BARRA CHAR(14),
    DESCRICAO VARCHAR(60),
    PRECOCUSTO NUMERIC(9,2),
    PRECOVENDA NUMERIC(9,2),
    TOTALCUSTO NUMERIC(9,2),
    TOTALVENDA NUMERIC(9,2),
    LUCRO NUMERIC(9,4),
    OCULTO CHAR(1),
    MINIMO NUMERIC(9,2),
    GRUPO VARCHAR(40),
    QUANTIDADE NUMERIC(9,2),
    TOTALSERVICO NUMERIC(9,2))
AS
DECLARE VARIABLE QCOMPRA NUMERIC(9,2);
DECLARE VARIABLE QVENDA NUMERIC(9,2);
BEGIN

    FOR
    SELECT
      PO.CODIGO,
      PO.BARRA,
      PO.DESCRICAO,
      PO.PRECOCUSTO,
      PO.PRECOVENDA,
      CAST(PO.MARGEM AS NUMERIC(9, 4)) AS LUCRO,
      PO.OCULTO,
      PO.MINIMO,
      GU.GRUPO,
      (
         SELECT
           SUM(QUANTIDADE)
         FROM
           INDIVIDUAIS ID
         WHERE
           ID.CODPRODUTO = PO.CODIGO AND
           ID.VENDIDO = 'N' AND
           ID.CODEMPRESA = :CODEMPRESA
      ) AS QUANTIDADE,
      (
         SELECT
           (SE.PRECOVENDA + PO.PRECOVENDA)
         FROM
           PRODUTOS SE
         WHERE
           SE.CODIGO = PO.CODSERVICO AND
           SE.PS = 'S'
       ) AS TOTALSERVICO
    FROM
      PRODUTOS PO
      LEFT JOIN GRUPOS GU ON
        (GU.CODIGO = PO.GRUPO)
    WHERE
      PO.PS = 'P'
    INTO
      :CODIGO,
      :BARRA,
      :DESCRICAO,
      :PRECOCUSTO,
      :PRECOVENDA,
      :LUCRO,
      :OCULTO,
      :MINIMO,
      :GRUPO,
      :QUANTIDADE,
      :TOTALSERVICO
    DO
    BEGIN
      IF (QUANTIDADE IS NULL) THEN
        QUANTIDADE = 0;

      /* COMPRAS NUMA DATA */
      SELECT
        SUM(QUANTIDADE)
      FROM
        INDIVIDUAIS
        JOIN MOVIMENTOS ON
          (MOVIMENTOS.CODIGO = INDIVIDUAIS.CODMOVENTRADA)
      WHERE
        INDIVIDUAIS.CODPRODUTO = :CODIGO AND
        INDIVIDUAIS.CODEMPRESA = :CODEMPRESA AND
        MOVIMENTOS.ES = 1 AND
        MOVIMENTOS.TIPO = 1 AND
        MOVIMENTOS.NO_ESTOQUE = 'S' AND
        MOVIMENTOS.DATA BETWEEN :DATA AND CURRENT_DATE
      INTO
        :QCOMPRA;

      IF (QCOMPRA IS NULL) THEN
        QCOMPRA = 0;

      /* VENDAS NUMA DATA */
      SELECT
        SUM(QUANTIDADE)
      FROM
        INDIVIDUAIS
        JOIN MOVIMENTOS ON
          (MOVIMENTOS.CODIGO = INDIVIDUAIS.CODMOVSAIDA)
      WHERE
        INDIVIDUAIS.CODPRODUTO = :CODIGO AND
        INDIVIDUAIS.CODEMPRESA = :CODEMPRESA AND
        INDIVIDUAIS.VENDIDO = 'S' AND
        MOVIMENTOS.ES = 2 AND
        MOVIMENTOS.TIPO IN (2,3,5,6) AND
        MOVIMENTOS.NO_ESTOQUE = 'S' AND
        MOVIMENTOS.DATA BETWEEN :DATA AND CURRENT_DATE
      INTO
        :QVENDA;

      IF (QVENDA IS NULL) THEN
        QVENDA = 0;

      QUANTIDADE = (QUANTIDADE + QVENDA) - QCOMPRA;

      IF (QUANTIDADE < 0) THEN
        QUANTIDADE = 0;
      TOTALCUSTO = (PRECOCUSTO * QUANTIDADE);
      TOTALVENDA = (PRECOVENDA * QUANTIDADE);

      SUSPEND;
    END

END
^

SET TERM ; ^

GRANT EXECUTE ON PROCEDURE ESTOQUE_DATA TO PUBLIC;

INSERT INTO SCRIPTVER(NUMERO, DATA) VALUES (448, CURRENT_TIMESTAMP);
COMMIT;
