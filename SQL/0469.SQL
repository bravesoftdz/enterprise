/*
** TRIBUTOS
*/

SET TERM ^ ;

CREATE OR ALTER TRIGGER VERIFICA_BARRA_UPD FOR PRODUTOS
INACTIVE BEFORE UPDATE POSITION 0
AS
DECLARE VARIABLE TEMP_EAN VARCHAR(13);
BEGIN
IF (NEW.INDIVIDUAL = 'N') THEN
BEGIN
EXECUTE PROCEDURE CALC_EAN13(NEW.BARRA)
RETURNING_VALUES :TEMP_EAN;
IF (NEW.BARRA <> TEMP_EAN) THEN
EXCEPTION PRODUTO_BARRA;
END
IF ((NEW.PRECOCUSTO < 0) OR (NEW.PRECOVENDA < 0)) THEN
EXCEPTION VALOR_ZERO;
IF (NEW.PESO IS NULL) THEN
NEW.PESO = 0;
--   IF (NEW.PRECOCUSTO > NEW.PRECOVENDA) THEN
--      EXCEPTION PRECOCUSTO_MAIOR;
END^

SET TERM ; ^

SET TERM ^ ;

CREATE OR ALTER TRIGGER PRODUTOS_MARGEM_UPD FOR PRODUTOS
INACTIVE BEFORE UPDATE POSITION 200
AS
BEGIN

  IF (NEW.CAIXA_ITENS IS NULL) THEN
    NEW.CAIXA_ITENS = 1;

  /* MARGEM */
  IF ((NEW.PRECOCUSTO = 0) AND (NEW.PRECOVENDA = 0)) THEN
   BEGIN

    NEW.MARGEM = 0;

   END ELSE
   BEGIN

     IF ((NEW.PRECOCUSTO = 0) AND (NEW.PRECOVENDA > 0)) THEN
      BEGIN

        NEW.MARGEM = NEW.PRECOVENDA * 100;

      END ELSE
      BEGIN

        NEW.MARGEM = (100 - ((NEW.PRECOVENDA * 100) / NEW.PRECOCUSTO)) * -1;

      END
   END

   IF (NEW.CODSERVICO IS NULL) THEN
    BEGIN

       NEW.PRECOSERVICO = 0;
       NEW.PRECOTOTAL   = NEW.PRECOVENDA;

    END ELSE NEW.PRECOTOTAL = NEW.PRECOSERVICO + NEW.PRECOVENDA;

END^

SET TERM ; ^

SET TERM ^ ;

CREATE OR ALTER TRIGGER PROVAR_UPD FOR PRODUTOS
INACTIVE AFTER UPDATE POSITION 10
AS
   DECLARE VARIABLE REAJUSTE NUMERIC(9,4);
BEGIN

   /* HOUVE ALGUM REAJUSTE? */
   IF (NEW.PRECOVENDA <> OLD.PRECOVENDA) THEN
    BEGIN
      IF (NEW.PRECOVENDA > OLD.PRECOVENDA) THEN
       BEGIN
         IF (OLD.PRECOVENDA = 0) THEN
            REAJUSTE = NEW.PRECOVENDA * 100;
         ELSE
            REAJUSTE = ((NEW.PRECOVENDA * 100) / OLD.PRECOVENDA) - 100;
       END ELSE
       BEGIN
         IF (NEW.PRECOVENDA = 0) THEN
            REAJUSTE = OLD.PRECOVENDA * -100;
         ELSE
            REAJUSTE = ((OLD.PRECOVENDA - NEW.PRECOVENDA) * -100) / OLD.PRECOVENDA;
       END
      INSERT INTO
        VARIACAO_VALOR (
          CODPRODUTO,
          DATA,
          VALOR_ANTIGO,
          VALOR_NOVO,
          REAJUSTE )
        VALUES (
          OLD.CODIGO,
          CURRENT_TIMESTAMP,
          OLD.PRECOVENDA,
          NEW.PRECOVENDA,
          :REAJUSTE);
    END

   IF (NEW.PS = 'S') THEN
    BEGIN
       UPDATE PRODUTOS SET PRODUTOS.PRECOSERVICO = NEW.PRECOVENDA
       WHERE PRODUTOS.CODSERVICO = NEW.CODIGO;
    END
END^

SET TERM ; ^

ALTER TABLE PRODUTOS ADD TRIBUTOS DINHEIRO;

UPDATE PRODUTOS SET TRIBUTOS = 0;

SET TERM ^ ;

CREATE OR ALTER TRIGGER PROVAR_UPD FOR PRODUTOS
ACTIVE AFTER UPDATE POSITION 10
AS
   DECLARE VARIABLE REAJUSTE NUMERIC(9,4);
BEGIN

   /* HOUVE ALGUM REAJUSTE? */
   IF (NEW.PRECOVENDA <> OLD.PRECOVENDA) THEN
    BEGIN
      IF (NEW.PRECOVENDA > OLD.PRECOVENDA) THEN
       BEGIN
         IF (OLD.PRECOVENDA = 0) THEN
            REAJUSTE = NEW.PRECOVENDA * 100;
         ELSE
            REAJUSTE = ((NEW.PRECOVENDA * 100) / OLD.PRECOVENDA) - 100;
       END ELSE
       BEGIN
         IF (NEW.PRECOVENDA = 0) THEN
            REAJUSTE = OLD.PRECOVENDA * -100;
         ELSE
            REAJUSTE = ((OLD.PRECOVENDA - NEW.PRECOVENDA) * -100) / OLD.PRECOVENDA;
       END
      INSERT INTO
        VARIACAO_VALOR (
          CODPRODUTO,
          DATA,
          VALOR_ANTIGO,
          VALOR_NOVO,
          REAJUSTE )
        VALUES (
          OLD.CODIGO,
          CURRENT_TIMESTAMP,
          OLD.PRECOVENDA,
          NEW.PRECOVENDA,
          :REAJUSTE);
    END

   IF (NEW.PS = 'S') THEN
    BEGIN
       UPDATE PRODUTOS SET PRODUTOS.PRECOSERVICO = NEW.PRECOVENDA
       WHERE PRODUTOS.CODSERVICO = NEW.CODIGO;
    END
END^

SET TERM ; ^

SET TERM ^ ;

CREATE OR ALTER TRIGGER PRODUTOS_MARGEM_UPD FOR PRODUTOS
ACTIVE BEFORE UPDATE POSITION 200
AS
BEGIN

  IF (NEW.CAIXA_ITENS IS NULL) THEN
    NEW.CAIXA_ITENS = 1;

  /* MARGEM */
  IF ((NEW.PRECOCUSTO = 0) AND (NEW.PRECOVENDA = 0)) THEN
   BEGIN

    NEW.MARGEM = 0;

   END ELSE
   BEGIN

     IF ((NEW.PRECOCUSTO = 0) AND (NEW.PRECOVENDA > 0)) THEN
      BEGIN

        NEW.MARGEM = NEW.PRECOVENDA * 100;

      END ELSE
      BEGIN

        NEW.MARGEM = (100 - ((NEW.PRECOVENDA * 100) / NEW.PRECOCUSTO)) * -1;

      END
   END

   IF (NEW.CODSERVICO IS NULL) THEN
    BEGIN

       NEW.PRECOSERVICO = 0;
       NEW.PRECOTOTAL   = NEW.PRECOVENDA;

    END ELSE NEW.PRECOTOTAL = NEW.PRECOSERVICO + NEW.PRECOVENDA;

END^

SET TERM ; ^

SET TERM ^ ;

CREATE OR ALTER TRIGGER VERIFICA_BARRA_UPD FOR PRODUTOS
ACTIVE BEFORE UPDATE POSITION 0
AS
DECLARE VARIABLE TEMP_EAN VARCHAR(13);
BEGIN
  IF (NEW.INDIVIDUAL = 'N') THEN
    BEGIN
      EXECUTE PROCEDURE CALC_EAN13(NEW.BARRA) RETURNING_VALUES :TEMP_EAN;
      IF (NEW.BARRA <> TEMP_EAN) THEN EXCEPTION PRODUTO_BARRA;
    END
  IF ((NEW.PRECOCUSTO < 0) OR (NEW.PRECOVENDA < 0)) THEN EXCEPTION VALOR_ZERO;
  IF (NEW.PESO IS NULL) THEN NEW.PESO = 0;
--   IF (NEW.PRECOCUSTO > NEW.PRECOVENDA) THEN
--      EXCEPTION PRECOCUSTO_MAIOR;
END^

SET TERM ; ^

INSERT INTO SCRIPTVER(NUMERO, DATA) VALUES (469, CURRENT_TIMESTAMP);
COMMIT;
