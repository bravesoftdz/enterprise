/*
** FECHAMENTO DE COMPRA
*/

SET TERM ^ ;

ALTER PROCEDURE VENDA_FECHA (
    CODMOVIMENTO INTEGER,
    USUARIOFECHAMENTO VARCHAR(30),
    OBSERVACOES VARCHAR(2048))
RETURNS (
    RE_MOVIMENTO INTEGER)
AS
DECLARE VARIABLE TIPO INTEGER;
DECLARE VARIABLE ES INTEGER;
DECLARE VARIABLE FECHADO CHAR(1);
BEGIN
  RE_MOVIMENTO = 0;
  FECHADO = 'N';

  /* LEIO O TIPO ATUAL */
  SELECT
    ES,
    TIPO
  FROM
    MOVIMENTOS
  WHERE
    CODIGO = :CODMOVIMENTO
  INTO
    :ES,
    :TIPO;

  IF (TIPO IN (1, 2, 5)) THEN
   BEGIN

     IF ((ES = 1) AND (TIPO = 1)) THEN
       FECHADO = 'S';

     IF ((ES = 2) AND (USUARIOFECHAMENTO > '')) THEN
      BEGIN

        IF (TIPO = 2) THEN
          TIPO = 3;
        ELSE
          TIPO = 6;

        FECHADO = 'S';

      END

     UPDATE
       MOVIMENTOS
     SET
       TIPO = :TIPO,
       USUARIOFECHAMENTO = :USUARIOFECHAMENTO,
       DATAFECHAMENTO = CURRENT_TIMESTAMP,
       OBSERVACOES = :OBSERVACOES,
       FECHADO = :FECHADO
     WHERE
       CODIGO = :CODMOVIMENTO;

     WHEN ANY DO RE_MOVIMENTO = 1;

   END

END
^

SET TERM ; ^




INSERT INTO SCRIPTVER(NUMERO, DATA) VALUES (326, CURRENT_TIMESTAMP);
COMMIT;

