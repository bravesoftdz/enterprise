/*
** NOVA RELAÇÃO ENTRE NATUREZA DE OPERAÇÃO E HISTÓRICO DE PAGAMENTOS
*/

SET TERM ^ ;

ALTER PROCEDURE GERAPARCELAS (
    CODIGO INTEGER)
AS
DECLARE VARIABLE TOTAL NUMERIC(9,2);
DECLARE VARIABLE PARCELA NUMERIC(9,2);
DECLARE VARIABLE CONDICAO VARCHAR(40);
DECLARE VARIABLE QUANTIDADE INTEGER;
DECLARE VARIABLE ES INTEGER;
DECLARE VARIABLE N INTEGER;
DECLARE VARIABLE CODPAG INTEGER;
DECLARE VARIABLE DATAMOV DATE;
DECLARE VARIABLE DIAS INTEGER;
DECLARE VARIABLE CODDOC INTEGER;
DECLARE VARIABLE CODPAGO INTEGER;
DECLARE VARIABLE DOCVISTA INTEGER;
DECLARE VARIABLE DOCPRAZO INTEGER;
DECLARE VARIABLE DESCRICAO CHAR(40);
DECLARE VARIABLE TIPO INTEGER;
DECLARE VARIABLE CODCONTA_COMPRADEB INTEGER;
DECLARE VARIABLE CODCONTA_VENDACRE INTEGER;
DECLARE VARIABLE CODCONTA INTEGER;
DECLARE VARIABLE NOME VARCHAR(16);
DECLARE VARIABLE CODCLIENTE INTEGER;
DECLARE VARIABLE CODEMPRESA INTEGER;
DECLARE VARIABLE CODCENTRO INTEGER;
DECLARE VARIABLE XES INTEGER;
DECLARE VARIABLE CODCONDPAG INTEGER;
DECLARE VARIABLE CODCENTRO_HP INTEGER;
DECLARE VARIABLE CODPLANO_HP INTEGER;
DECLARE VARIABLE VENDA CHAR(1);
BEGIN

   /* DADOS DO MOVIMENTO */
   SELECT
      NOTA_VALOR_TOTAL,
      CONDICAO,
      ES,
      CURRENT_DATE,
      TIPO,
      CODCLIENTE,
      CODEMPRESA,
      CODCENTRO,
      CODCONDPAG
   FROM
      MOVIMENTOS
   WHERE
      CODIGO = :CODIGO
   INTO
      :TOTAL,
      :CONDICAO,
      :ES,
      :DATAMOV,
      :TIPO,
      :CODCLIENTE,
      :CODEMPRESA,
      :CODCENTRO,
      :CODCONDPAG;

   /* TEM FATURAMENTO? */
   SELECT
     NA.VENDA
   FROM
     NATUOPER NA
     JOIN MOVIMENTOS MO ON
       (MO.NOTA_CODNATUOPER = NA.CODIGO)
   WHERE
     MO.CODIGO = :CODIGO
   INTO
     :VENDA;

   IF (CODCENTRO_HP IS NULL) THEN
     CODCENTRO_HP = CODCENTRO;

   IF (VENDA = 'N') THEN
     EXIT;

   /* DADOS DO PERFIL DA EMPRESA */
   SELECT
      CODDOC_AVISTA,
      CODDOC_PRAZO,
      CODCONTA_COMPRADEB,
      CODCONTA_VENDACRE
   FROM
      SISCONFIG
   WHERE
      CODIGO = :CODEMPRESA
   INTO
      :DOCVISTA,
      :DOCPRAZO,
      :CODCONTA_COMPRADEB,
      :CODCONTA_VENDACRE;

   /* SE FOR ENTRADA */
   IF (ES = 1) THEN
    BEGIN
      CODCONTA = CODCONTA_COMPRADEB;
      SELECT
        UDF_LEFT(NOME, 16)
      FROM
        CLIENTES
      WHERE
        CODIGO = :CODCLIENTE
      INTO
        :NOME;
    END ELSE

    /* SE FOR UMA SAIDA */
    BEGIN
     CODCONTA = CODCONTA_VENDACRE;
     SELECT
       UDF_LEFT(NOME, 16)
     FROM
       CLIENTES
     WHERE
       CODIGO = :CODCLIENTE
     INTO
       :NOME;
   END

   /* SE O VALOR FOR ZERO NAO GERO NADA */
   IF (TOTAL <= 0) THEN EXIT;

   /* QUANTIDADE DE PARCELAS */
   SELECT
      COUNT(*)
   FROM
      PARCELAS(
        :CONDICAO
      )
   INTO
      :QUANTIDADE;

   /* SE TIVER PELO MENOS 1 PARCELA, GERO */
   IF (QUANTIDADE > 0) THEN
    BEGIN

      /* APAGO AS PARCELAS ANTIGAS */
      DELETE FROM
        PAGAMENTOS
      WHERE
        CODMOVIMENTO = :CODIGO;

      /* VALOR DA PARCELA */
      PARCELA = CAST((TOTAL / QUANTIDADE) AS INTEGER);

      /* GERACAO DAS PARCELAS */
      N = 0;
      FOR
      SELECT
        DIAS
      FROM
        PARCELAS(:CONDICAO)
      INTO
        :DIAS
      DO
      BEGIN

        /* NUMERO DA PARCELA */
        N = N + 1;

        /* DESCRICAO DA PARCELA */
        IF (ES = 1) THEN
          DESCRICAO = 'PARC ' || N || '/' || QUANTIDADE || ' COMPRA ' || CODIGO || ' ' || NOME;
        ELSE
          DESCRICAO = 'PARC ' || N || '/' || QUANTIDADE || ' VENDA ' || CODIGO || ' ' || NOME;

        /* CODIGO SEQUENCIAL */
        SELECT
          SEQUENCIA
        FROM
          SEQ_OBTER('PAGAMENTOS')
        INTO
          :CODPAG;

        /* PARCELA A VISTA X PARCELA A PRAZO */
        IF (DIAS = 0) THEN
         BEGIN
           CODDOC = DOCVISTA;
           CODPAGO = 0;
         END ELSE
         BEGIN
           CODDOC = DOCPRAZO;
           CODPAGO = 0;
         END

        /* ESCONDO OS PAGAMENTOS DE OS E VENDA ABERTAS */
        XES = ES;
        IF ((XES = 2) AND (TIPO IN (3, 5))) THEN
          XES = 0;

        /* INSIRO A PARCELA */
        INSERT INTO
          PAGAMENTOS (
            CODIGO,
            CODMOVIMENTO,
            NUMERO,
            DESCRICAO,
            ES,
            VALOR,
            DATAVENCIMENTO,
            CODDOCUMENTO,
            PAGO,
            CODCONTA,
            CODEMPRESA,
            CODCENTRO,
            CODPLANO,
            CODCLIENTE)
          VALUES (
            :CODPAG,
            :CODIGO,
            :N,
            :DESCRICAO,
            :XES,
            :PARCELA,
            :DATAMOV + :DIAS,
            :CODDOC,
            :CODPAGO,
            :CODCONTA,
            :CODEMPRESA,
            :CODCENTRO_HP,
            :CODPLANO_HP,
            :CODCLIENTE);
      END

      /* DIFERENÇA NA PRIMEIRA PARCELA */
      UPDATE
        PAGAMENTOS
      SET
        VALOR = VALOR + (:TOTAL - (:PARCELA * :QUANTIDADE))
      WHERE
        CODMOVIMENTO = :CODIGO AND NUMERO = 1;

    END ELSE EXCEPTION CONDICAO_ERRADA;
END
^

SET TERM ; ^

ALTER TABLE NATUOPER DROP CODHISTORICOPAG;

ALTER TABLE HISTORICOPAG ADD CODNATUOPER STR05;

ALTER TABLE MOVIMENTOS ADD CODHISTORICOPAG INTEIRO;

alter table MOVIMENTOS
add constraint MOVIMENTOS_FK14
foreign key (CODHISTORICOPAG)
references HISTORICOPAG(CODIGO)
on update CASCADE;

alter table HISTORICOPAG
add constraint HISTORICOPAG_FK03
foreign key (CODNATUOPER)
references NATUOPER(CODIGO)
on update CASCADE;

SET TERM ^ ;

ALTER TRIGGER STATUS_INSERT
ACTIVE BEFORE INSERT POSITION 0
AS
BEGIN

  IF (NEW.TIPO = 1) THEN
   BEGIN
     IF (NEW.ES = 0) THEN
       NEW.STATUS = 'ORC ABERTO';
     IF (NEW.ES = 1) THEN
       NEW.STATUS = 'COMPRA';
   END
  IF (NEW.TIPO = 2) THEN NEW.STATUS = 'OS ABERTA';
  IF (NEW.TIPO = 3) THEN NEW.STATUS = 'OS FECHADA';
  IF (NEW.TIPO = 4) THEN NEW.STATUS = 'PRODUÇÃO';
  IF (NEW.TIPO = 5) THEN NEW.STATUS = 'VENDA ABERTA';
  IF (NEW.TIPO = 6) THEN NEW.STATUS = 'VENDA FECHADA';
  IF (NEW.TIPO = 7) THEN NEW.STATUS = 'N/F';
  IF (NEW.TIPO = 8) THEN NEW.STATUS = 'REMESSA';
  IF (NEW.TIPO = 9) THEN NEW.STATUS = 'ESTORNADO';

  /* VERIFICO O NUMERADOR */
  EXECUTE PROCEDURE VALIDA_NUMERADOR(NEW.NUMERADOR, NEW.CODCLIENTE,
    NEW.CODMARCA, NEW.CODMODELO, NEW.SERIE);

  /* BASES DE CALCULO DO ICMS E ISS */
  SELECT
    ALIQUOTA_ISS,
    ALIQUOTA_ICMSSIMPLES,
    ICMSSIMPLES
  FROM
    SISCONFIG
  WHERE
    CODIGO = NEW.CODEMPRESA
  INTO
    NEW.ISSALIQ,
    NEW.ICMSSIMPALIQ,
    NEW.ICMSSIMPLES;

  /* CONFIGURAÇÕES DO HISTÓRIO DE PAGAMENTOS */
  if (NEW.CODHISTORICOPAG IS NOT NULL) then
   BEGIN
     SELECT
       CODNATUOPER
     FROM
       HISTORICOPAG
     WHERE
       CODIGO = NEW.CODHISTORICOPAG
     INTO
       NEW.NOTA_CODNATUOPER;
   END

  /* CONFIGURAÇÕES DA NATUREZA DE OPERAÇÃO */
  SELECT
    VENDA,
    ESTOQUE,
    ICMS,
    IPI
  FROM
    NATUOPER
  WHERE
    CODIGO = NEW.NOTA_CODNATUOPER
  INTO
    NEW.NO_VENDA,
    NEW.NO_ESTOQUE,
    NEW.NO_ICMS,
    NEW.NO_IPI;

  /* INICIALIZAÇÃO DO RETORNO */
  NEW.RETORNO = 'N';

END
^

SET TERM ; ^

SET TERM ^ ;

ALTER TRIGGER STATUS_UPDATE
ACTIVE BEFORE UPDATE POSITION 0
AS
DECLARE VARIABLE PRIMEIRO TIMESTAMP;
DECLARE VARIABLE ULTIMO TIMESTAMP;
DECLARE VARIABLE TOTAL DOUBLE PRECISION;
DECLARE VARIABLE TDATAINI TIMESTAMP;
DECLARE VARIABLE TDATAFIM TIMESTAMP;
BEGIN

   /* DATA DA ENTREGA */
   IF ((NEW.QUEM_RECEBEU IS NOT NULL) AND (OLD.QUEM_RECEBEU IS NULL)) THEN
     NEW.DATA_ENTREGA = CURRENT_TIMESTAMP;

   /* DATA DA AUTORIZAÇÃO */
   IF ((NEW.QUEM_AUTORIZOU IS NOT NULL) AND (OLD.QUEM_AUTORIZOU IS NULL)) THEN
     NEW.DATA_AUTORIZADO = CURRENT_TIMESTAMP;

   /* CONFIGURAÇÕES DO HISTÓRIO DE PAGAMENTOS */
   if (NEW.CODHISTORICOPAG IS NOT NULL) then
    BEGIN
      SELECT
        CODNATUOPER
      FROM
        HISTORICOPAG
      WHERE
        CODIGO = NEW.CODHISTORICOPAG
      INTO
        NEW.NOTA_CODNATUOPER;
    END

   /* CONFIGURAÇÕES DA NATUREZA DE OPERAÇÃO */
   SELECT
     VENDA,
     ESTOQUE,
     ICMS,
     IPI
   FROM
     NATUOPER
   WHERE
     CODIGO = NEW.NOTA_CODNATUOPER
   INTO
     NEW.NO_VENDA,
     NEW.NO_ESTOQUE,
     NEW.NO_ICMS,
     NEW.NO_IPI;

   IF (NEW.TIPO = 1) THEN
    BEGIN

      IF (NEW.ES = 0) THEN
       BEGIN
         NEW.STATUS = 'ORC ABERTO';
         IF (NEW.AUTORIZADO = 'S') THEN
          BEGIN
            NEW.STATUS = 'ORC AUTORIZADO';
          END ELSE
          BEGIN
            IF (NEW.DATA_AUTORIZADO IS NOT NULL) THEN
              NEW.STATUS = 'ORC NAO AUTO';
            IF ((NEW.RETORNO = 'S') AND (NEW.DATA_RETORNO IS NOT NULL)) THEN
              NEW.STATUS = 'ORC RETORNAR';
          END
       END

      IF (NEW.ES = 1) THEN
       BEGIN
         if (NEW.FECHADO = 'S') then
            NEW.STATUS = 'COMPRA';
         ELSE
            NEW.STATUS = 'PED COMPRA';
       END

    END

   IF (NEW.TIPO = 2) THEN
    BEGIN
      NEW.STATUS = 'OS ABERTA';

      /* VERIFICO SE O TECNICO JÁ INICIOU */
      SELECT FIRST 1
        DATAINI,
        DATAFIM
      FROM
        OS_VENDER
      WHERE
        CODMOVIMENTO = NEW.CODIGO
      INTO
        :TDATAINI,
        :TDATAFIM;

      IF (TDATAINI IS NOT NULL) THEN
       BEGIN
         NEW.STATUS = 'OS INICIADA';

         IF (NEW.DATA_AUTORIZADO IS NOT NULL) THEN
          BEGIN

            IF (NEW.AUTORIZADO = 'N') THEN
              NEW.STATUS = 'OS NAO AUTO';
            ELSE
              IF (TDATAFIM IS NULL) THEN
                NEW.STATUS = 'OS AUTORIZADA';
              ELSE
                NEW.STATUS = 'OS CONCLUIDA';
          END

         IF (NEW.DATA_ENTREGA IS NOT NULL) THEN
           NEW.STATUS = 'OS ENTREGUE';

       END
    END

   IF (NEW.TIPO = 3) THEN NEW.STATUS = 'OS FECHADA';
   IF (NEW.TIPO = 4) THEN NEW.STATUS = 'PRODUÇÃO';
   IF (NEW.TIPO = 5) THEN NEW.STATUS = 'VENDA ABERTA';
   IF (NEW.TIPO = 6) THEN NEW.STATUS = 'VENDA FECHADA';
   IF (NEW.TIPO = 7) THEN NEW.STATUS = 'N/F';
   IF (NEW.TIPO = 8) THEN NEW.STATUS = 'REMESSA';
   IF (NEW.TIPO = 9) THEN NEW.STATUS = 'ESTORNO';

   /* VERIFICO O NUMERADOR */
   EXECUTE PROCEDURE VALIDA_NUMERADOR(NEW.NUMERADOR, NEW.CODCLIENTE,
     NEW.CODMARCA, NEW.CODMODELO, NEW.SERIE);

   /* calcular impostos */
   IF ((NEW.ES = 2)                  AND
       (NEW.TIPO IN (3, 6))          AND
       (OLD.TIPO IN (2, 5)))         THEN
    BEGIN
      /* TOTAL ICMS */
      EXECUTE PROCEDURE CALC_ICMS(NEW.CODIGO)
        RETURNING_VALUES NEW.VALOR_ICMS, NEW.VALOR_IPI_PRODUTOS;
      IF (NEW.NO_ICMS = 'N') THEN
        NEW.VALOR_ICMS = 0;
      IF (NEW.NO_IPI = 'N') THEN
        NEW.VALOR_IPI_PRODUTOS = 0;
    END

   /* FECHOU A VENDA */
   IF ((OLD.TIPO IN (2, 5)) AND (NEW.TIPO IN (3, 6))) THEN
    BEGIN

      /* USUÁRIO, DATA E HORA DO FECHAMENTO */
      NEW.DATAFECHAMENTO = 'NOW';

      NEW.FECHADO = 'S';

      IF ((UDF_TRIM(NEW.USUARIOFECHAMENTO) = '') OR (NEW.USUARIOFECHAMENTO IS NULL)) THEN
        NEW.USUARIOFECHAMENTO = USER;

      /* VINCULAR SERIAL NA VENDA FECHADA */
      IF (NEW.TIPO = 6) THEN
        EXECUTE PROCEDURE VINCULO_SERIE NEW.CODIGO
          RETURNING_VALUES NEW.SERIE;

      /* TEMPOS DE ATENDIMENTO, SE FOR OS */
      IF (NEW.TIPO = 3) THEN
       BEGIN

         SELECT
           MIN(DATAINI),
           MAX(DATAFIM),
           SUM(THORAS)
         FROM
           OS_VENDER
         WHERE
           CODMOVIMENTO = NEW.CODIGO
         INTO
           :PRIMEIRO,
           :ULTIMO,
           :TOTAL;

         NEW.TEMPO_CHEGADA    = CAST(
           UDF_MINUTESBETWEEN(NEW.DATA, PRIMEIRO)
           AS DOUBLE PRECISION) / 60;

         NEW.TEMPO_CONCLUSAO  = CAST(
           UDF_MINUTESBETWEEN(NEW.DATA, ULTIMO)
           AS DOUBLE PRECISION) / 60;

         NEW.TEMPO_LANCAMENTO = CAST(
           UDF_MINUTESBETWEEN(ULTIMO, NEW.DATAFECHAMENTO)
           AS DOUBLE PRECISION) / 60;

         NEW.TEMPO_TECNICOS = TOTAL;

         NEW.DATAINICIO  = PRIMEIRO;

         NEW.DATATERMINO = ULTIMO;

         IF (PRIMEIRO > NEW.DATAPREVISAO) THEN
           NEW.TEMPO_FORADOPRAZO = CAST(
             UDF_MINUTESBETWEEN(NEW.DATAPREVISAO, PRIMEIRO)
             AS DOUBLE PRECISION) / 60;
         ELSE
           NEW.TEMPO_FORADOPRAZO = 0;

       END

      NEW.TEMPO_CICLO = CAST(
        UDF_MINUTESBETWEEN(NEW.DATA, NEW.DATAFECHAMENTO)
        AS DOUBLE PRECISION) / 60;

    END

   /* RATEIO DOS CUSTOS DE COMPRA */
   IF ((NEW.ES = 1) AND (NEW.TIPO = 1)) THEN
     EXECUTE PROCEDURE RATEIO_CUSTOS (
       NEW.CODIGO,
       NEW.VALOR_PRODUTOS,
       NEW.VALOR_RATEIO_CUSTO);

END
^

SET TERM ; ^

SET TERM ^ ;

ALTER PROCEDURE GERAPARCELAS (
    CODIGO INTEGER)
AS
DECLARE VARIABLE TOTAL NUMERIC(9,2);
DECLARE VARIABLE PARCELA NUMERIC(9,2);
DECLARE VARIABLE CONDICAO VARCHAR(40);
DECLARE VARIABLE QUANTIDADE INTEGER;
DECLARE VARIABLE ES INTEGER;
DECLARE VARIABLE N INTEGER;
DECLARE VARIABLE CODPAG INTEGER;
DECLARE VARIABLE DATAMOV DATE;
DECLARE VARIABLE DIAS INTEGER;
DECLARE VARIABLE CODDOC INTEGER;
DECLARE VARIABLE CODPAGO INTEGER;
DECLARE VARIABLE DOCVISTA INTEGER;
DECLARE VARIABLE DOCPRAZO INTEGER;
DECLARE VARIABLE DESCRICAO CHAR(40);
DECLARE VARIABLE TIPO INTEGER;
DECLARE VARIABLE CODCONTA_COMPRADEB INTEGER;
DECLARE VARIABLE CODCONTA_VENDACRE INTEGER;
DECLARE VARIABLE CODCONTA INTEGER;
DECLARE VARIABLE CODCLIENTE INTEGER;
DECLARE VARIABLE CODEMPRESA INTEGER;
DECLARE VARIABLE CODCENTRO INTEGER;
DECLARE VARIABLE XES INTEGER;
DECLARE VARIABLE CODCONDPAG INTEGER;
DECLARE VARIABLE CODCENTRO_HP INTEGER;
DECLARE VARIABLE CODPLANO_HP INTEGER;
DECLARE VARIABLE VENDA CHAR(1);
declare variable CODHISTORICOPAG INTEGER;
BEGIN

   /* DADOS DO MOVIMENTO */
   SELECT
      NOTA_VALOR_TOTAL,
      CONDICAO,
      ES,
      CURRENT_DATE,
      TIPO,
      CODCLIENTE,
      CODEMPRESA,
      CODCENTRO,
      CODCONDPAG,
      NO_VENDA,
      CODHISTORICOPAG
   FROM
      MOVIMENTOS
   WHERE
      CODIGO = :CODIGO
   INTO
      :TOTAL,
      :CONDICAO,
      :ES,
      :DATAMOV,
      :TIPO,
      :CODCLIENTE,
      :CODEMPRESA,
      :CODCENTRO,
      :CODCONDPAG,
      :VENDA,
      :CODHISTORICOPAG;

   /* TEM FATURAMENTO? */
   SELECT
     HP.CODCENTRO,
     HP.CODPLANO
   FROM
     HISTORICOPAG HP
   WHERE
     HP.CODIGO = :CODHISTORICOPAG
   INTO
     :CODCENTRO_HP,
     :CODPLANO_HP;

   IF (CODCENTRO_HP IS NULL) THEN
     CODCENTRO_HP = CODCENTRO;

   IF (VENDA = 'N') THEN
     EXIT;

   /* DADOS DO PERFIL DA EMPRESA */
   SELECT
      CODDOC_AVISTA,
      CODDOC_PRAZO,
      CODCONTA_COMPRADEB,
      CODCONTA_VENDACRE
   FROM
      SISCONFIG
   WHERE
      CODIGO = :CODEMPRESA
   INTO
      :DOCVISTA,
      :DOCPRAZO,
      :CODCONTA_COMPRADEB,
      :CODCONTA_VENDACRE;

   /* SE FOR ENTRADA */
   IF (ES = 1) THEN
    BEGIN
      CODCONTA = CODCONTA_COMPRADEB;
    END ELSE

    /* SE FOR UMA SAIDA */
    BEGIN
     CODCONTA = CODCONTA_VENDACRE;
    END

   /* SE O VALOR FOR ZERO NAO GERO NADA */
   IF (TOTAL <= 0) THEN EXIT;

   /* QUANTIDADE DE PARCELAS */
   SELECT
      COUNT(*)
   FROM
      PARCELAS(
        :CONDICAO
      )
   INTO
      :QUANTIDADE;

   /* SE TIVER PELO MENOS 1 PARCELA, GERO */
   IF (QUANTIDADE > 0) THEN
    BEGIN

      /* APAGO AS PARCELAS ANTIGAS */
      DELETE FROM
        PAGAMENTOS
      WHERE
        CODMOVIMENTO = :CODIGO;

      /* VALOR DA PARCELA */
      PARCELA = CAST((TOTAL / QUANTIDADE) AS INTEGER);

      /* GERACAO DAS PARCELAS */
      N = 0;
      FOR
      SELECT
        DIAS
      FROM
        PARCELAS(:CONDICAO)
      INTO
        :DIAS
      DO
      BEGIN

        /* NUMERO DA PARCELA */
        N = N + 1;

        /* DESCRICAO DA PARCELA */
        IF (ES = 1) THEN
          DESCRICAO = 'ENTRADA ' || CODIGO || '/' || N || ' DE ' || QUANTIDADE;
        ELSE
          DESCRICAO = 'SAIDA ' || CODIGO || '/' || N || ' DE ' || QUANTIDADE;

        /* CODIGO SEQUENCIAL */
        SELECT
          SEQUENCIA
        FROM
          SEQ_OBTER('PAGAMENTOS')
        INTO
          :CODPAG;

        /* PARCELA A VISTA X PARCELA A PRAZO */
        IF (DIAS = 0) THEN
         BEGIN
           CODDOC = DOCVISTA;
           CODPAGO = 0;
         END ELSE
         BEGIN
           CODDOC = DOCPRAZO;
           CODPAGO = 0;
         END

        /* ESCONDO OS PAGAMENTOS DE OS E VENDA ABERTAS */
        XES = ES;
        IF ((XES = 2) AND (TIPO IN (3, 5))) THEN
          XES = 0;

        /* INSIRO A PARCELA */
        INSERT INTO
          PAGAMENTOS (
            CODIGO,
            CODMOVIMENTO,
            NUMERO,
            DESCRICAO,
            ES,
            VALOR,
            DATAVENCIMENTO,
            CODDOCUMENTO,
            PAGO,
            CODCONTA,
            CODEMPRESA,
            CODCENTRO,
            CODPLANO,
            CODCLIENTE)
          VALUES (
            :CODPAG,
            :CODIGO,
            :N,
            :DESCRICAO,
            :XES,
            :PARCELA,
            :DATAMOV + :DIAS,
            :CODDOC,
            :CODPAGO,
            :CODCONTA,
            :CODEMPRESA,
            :CODCENTRO_HP,
            :CODPLANO_HP,
            :CODCLIENTE);
      END

      /* DIFERENÇA NA PRIMEIRA PARCELA */
      UPDATE
        PAGAMENTOS
      SET
        VALOR = VALOR + (:TOTAL - (:PARCELA * :QUANTIDADE))
      WHERE
        CODMOVIMENTO = :CODIGO AND NUMERO = 1;

    END ELSE EXCEPTION CONDICAO_ERRADA;
END
^

SET TERM ; ^

SET TERM ^ ;

ALTER TRIGGER MOVIMENTOS_AFTINS
AS
BEGIN
  IF (NEW.ES IN (0, 1, 2)) THEN
    IF (NEW.VALOR_TOTAL > 0) THEN
      EXECUTE PROCEDURE GERAPARCELAS(NEW.CODIGO);
END
^

SET TERM ; ^

SET TERM ^ ;

ALTER TRIGGER MOVIMENTOS_AFTUPD
AS
DECLARE VARIABLE CODORIGEM INTEGER;
DECLARE VARIABLE CODUSUARIO INTEGER;
DECLARE VARIABLE TEMP_CODIGO INTEGER;
DECLARE VARIABLE TEMP_CODPRODUTO INTEGER;
DECLARE VARIABLE TEMP_SERIE VARCHAR(20);
DECLARE VARIABLE TEMP_SERIE2 VARCHAR(20);
DECLARE VARIABLE TEMP_VALOR_VENDA NUMERIC(9,2);
DECLARE VARIABLE TEMP_DESCONTO NUMERIC(9,2);
DECLARE VARIABLE TEMP_BARRA VARCHAR(20);
DECLARE VARIABLE TEMP_ICMSVENDA NUMERIC(9,4);
DECLARE VARIABLE TEMP_QUANTIDADE NUMERIC(9,2);
BEGIN
IF (NEW.ES IN (0, 1, 2)) THEN
BEGIN
IF (((NEW.VALOR_TOTAL <> OLD.VALOR_TOTAL) OR
(NEW.CONDICAO <> OLD.CONDICAO)) AND
(NEW.TIPO IN (0, 1, 2, 5))) THEN
EXECUTE PROCEDURE GERAPARCELAS(NEW.CODIGO);
IF ((NEW.TIPO IN (3, 6)) AND (OLD.TIPO IN (2, 5))) THEN
BEGIN
EXECUTE PROCEDURE COMISSAO_CALC(NEW.CODIGO);
EXECUTE PROCEDURE AUTOBAIXA(NEW.CODIGO);
EXECUTE PROCEDURE CADASTRA_EQUIPAMENTO(NEW.CODIGO);
END
END
/* ESTORNO */
IF ((NEW.TIPO = 9) AND (OLD.TIPO <> 9)) THEN
BEGIN
/* GUARDO OS ITENS ESTORNADOS */
FOR
SELECT
CODPRODUTO,
SERIE,
SERIE2,
VALOR_VENDA,
DESCONTO,
BARRA,
ICMSVENDA,
SUM(QUANTIDADE)
FROM
INDIVIDUAIS
WHERE
CODMOVSAIDA = NEW.CODIGO
GROUP BY
CODPRODUTO,
SERIE,
SERIE2,
VALOR_VENDA,
DESCONTO,
BARRA,
ICMSVENDA
INTO
TEMP_CODPRODUTO,
TEMP_SERIE,
TEMP_SERIE2,
TEMP_VALOR_VENDA,
TEMP_DESCONTO,
TEMP_BARRA,
TEMP_ICMSVENDA,
TEMP_QUANTIDADE
DO
BEGIN
/* CODIGO UNICO DO TEMPITENS */
EXECUTE PROCEDURE SEQ_OBTER('TEMPITENS')
RETURNING_VALUES TEMP_CODIGO;
/* GUARDO ITEM UM A UM */
INSERT INTO
TEMPITENS (
CODIGO,
CODMOVIMENTO,
CODPRODUTO,
QUANTIDADE,
VALOR_UNITARIO,
DESCONTO,
SITTRIBU,
MARGEM,
REAJUSTAR,
VALOR_VENDA,
ICMSCOMPRA,
ICMSVENDA,
IPI,
SERIE,
SERIE2,
BARRA)
VALUES (
:TEMP_CODIGO,
NEW.CODIGO,
:TEMP_CODPRODUTO,
:TEMP_QUANTIDADE,
:TEMP_VALOR_VENDA,
:TEMP_DESCONTO,
'0.0',
0,
'N',
(:TEMP_VALOR_VENDA - :TEMP_DESCONTO),
:TEMP_ICMSVENDA,
:TEMP_ICMSVENDA,
0,
:TEMP_SERIE,
:TEMP_SERIE2,
:TEMP_BARRA);
END
/* VERIFICO SE POSSUI MOVIMENTAÇÃO DE ESTOQUE */
IF (NEW.NO_ESTOQUE = 'S') THEN
BEGIN
/* DEVOLVO OS PRODUTOS */
UPDATE
INDIVIDUAIS
SET
VENDIDO = 'N'
WHERE
CODMOVSAIDA = NEW.CODIGO;
END ELSE
BEGIN
/* DEVOLVO OS PRODUTOS */
UPDATE
INDIVIDUAIS
SET
VENDIDO = 'N'
WHERE
CODMOVSAIDA = NEW.CODIGO;
/* SIMPLESMENTE EXCLUO OS ITENS */
DELETE FROM
INDIVIDUAIS
WHERE
CODMOVSAIDA = NEW.CODIGO;
END
/* VERIFICO SE EXISTE MOVIMENTACAO FINANCEIRA */
IF (NEW.NO_VENDA = 'S') THEN
BEGIN
/* CODIGO DO USUARIO */
SELECT
CODIGO
FROM
CLIENTES
WHERE
NOMEUSER = NEW.USUARIOESTORNO
INTO
:CODUSUARIO;
/* VERIFICO OS PAGAMENTOS E ESTORNO 1 A 1 */
FOR
SELECT
CODIGO
FROM
PAGAMENTOS
WHERE
CODMOVIMENTO = NEW.CODIGO
INTO
:CODORIGEM
DO
EXECUTE PROCEDURE FINANC_ESTORNO(:CODORIGEM, :CODUSUARIO);
END
END
END
^

SET TERM ; ^

INSERT INTO SCRIPTVER(NUMERO, DATA) VALUES (337, CURRENT_TIMESTAMP);
COMMIT;

