/*
** BUG NA NATUREZA DE OPERAÇÃO DAS COMPRAS DO SISTEMA ANTIGO
*/

SET TERM ^ ;

ALTER TRIGGER STATUS_INSERT
ACTIVE BEFORE INSERT POSITION 0
AS
BEGIN

  IF (NEW.TIPO = 1) THEN
   BEGIN
     IF (NEW.ES = 0) THEN
       NEW.STATUS = 'ORC ABERTO';
     IF (NEW.ES = 1) THEN
       NEW.STATUS = 'COMPRA';
   END
  IF (NEW.TIPO = 2) THEN NEW.STATUS = 'OS ABERTA';
  IF (NEW.TIPO = 3) THEN NEW.STATUS = 'OS FECHADA';
  IF (NEW.TIPO = 4) THEN NEW.STATUS = 'PRODUÇÃO';
  IF (NEW.TIPO = 5) THEN NEW.STATUS = 'VENDA ABERTA';
  IF (NEW.TIPO = 6) THEN NEW.STATUS = 'VENDA FECHADA';
  IF (NEW.TIPO = 7) THEN NEW.STATUS = 'N/F';
  IF (NEW.TIPO = 8) THEN NEW.STATUS = 'REMESSA';
  IF (NEW.TIPO = 9) THEN NEW.STATUS = 'ESTORNADO';

  /* VERIFICO O NUMERADOR */
  EXECUTE PROCEDURE VALIDA_NUMERADOR(NEW.NUMERADOR, NEW.CODCLIENTE,
    NEW.CODMARCA, NEW.CODMODELO, NEW.SERIE);

  /* BASES DE CALCULO DO ICMS E ISS */
  SELECT
    ALIQUOTA_ISS,
    ALIQUOTA_ICMSSIMPLES,
    ICMSSIMPLES
  FROM
    SISCONFIG
  WHERE
    CODIGO = NEW.CODEMPRESA
  INTO
    NEW.ISSALIQ,
    NEW.ICMSSIMPALIQ,
    NEW.ICMSSIMPLES;

  /* CONFIGURAÇÕES DO HISTÓRIO DE PAGAMENTOS */
  IF (NEW.CODHISTORICOPAG IS NOT NULL) THEN
   BEGIN
     SELECT
       CODNATUOPER
     FROM
       HISTORICOPAG
     WHERE
       CODIGO = NEW.CODHISTORICOPAG
     INTO
       NEW.NOTA_CODNATUOPER;
   END ELSE
   BEGIN

     IF (NEW.NOTA_CODNATUOPER IS NULL) THEN
      BEGIN

        IF ((NEW.ES = 1) AND (NEW.TIPO = 1)) THEN
         BEGIN

           SELECT
             SI.NATUOPER_COMPRA
           FROM
             SISCONFIG SI
           WHERE
             SI.CODIGO = NEW.CODEMPRESA
           INTO
             NEW.NOTA_CODNATUOPER;

         END
      END

   END

  /* CONFIGURAÇÕES DA NATUREZA DE OPERAÇÃO */
  SELECT
    VENDA,
    ESTOQUE,
    ICMS,
    IPI
  FROM
    NATUOPER
  WHERE
    CODIGO = NEW.NOTA_CODNATUOPER
  INTO
    NEW.NO_VENDA,
    NEW.NO_ESTOQUE,
    NEW.NO_ICMS,
    NEW.NO_IPI;

  /* INICIALIZAÇÃO DO RETORNO */
  NEW.RETORNO = 'N';

END
^

SET TERM ; ^

INSERT INTO SCRIPTVER(NUMERO, DATA) VALUES (345, CURRENT_TIMESTAMP);
COMMIT;

