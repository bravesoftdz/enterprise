/*
** SEGURANÇA NAS CONDIÇÕES DE PAGAMENTO
*/

UPDATE RDB$RELATION_FIELDS SET
RDB$FIELD_SOURCE = 'INTEIRO_VALIDO'
WHERE (RDB$FIELD_NAME = 'CODDOC_AVISTA') AND
(RDB$RELATION_NAME = 'CONDPAG');

UPDATE RDB$RELATION_FIELDS SET
RDB$FIELD_SOURCE = 'INTEIRO_VALIDO'
WHERE (RDB$FIELD_NAME = 'CODDOC_PRAZO') AND
(RDB$RELATION_NAME = 'CONDPAG');

SET TERM ^ ;

ALTER TRIGGER CONDPAG_BI0
ACTIVE BEFORE INSERT POSITION 0
AS
DECLARE VARIABLE CONTADOR INTEGER;
BEGIN

  /* CONDICAO */
  IF ((NEW.CONDICAO IS NULL) OR (UDF_TRIM(NEW.CONDICAO) = '')) THEN
    EXCEPTION CONDICAO_ERRADA;

  IF (UDF_COPY(UDF_TRIM(NEW.CONDICAO), UDF_LEN(UDF_TRIM(NEW.CONDICAO)), 1) <> '/') THEN
    EXCEPTION CONDICAO_ERRADA;

  /* PREENCHO QUANTIDADE E PRAZO MEDIO */
  SELECT
    COUNT(DIAS),
    AVG(DIAS)
  FROM
    PARCELAS(NEW.CONDICAO)
  INTO
    NEW.QUANTIDADE,
    NEW.PRAZOMEDIO;

  IF (NEW.QUANTIDADE IS NULL) THEN
    EXCEPTION CONDICAO_ERRADA;

  /* EXISTE PARCELA A VISTA? */
  SELECT
    COUNT(*)
  FROM
    PARCELAS(NEW.CONDICAO)
  WHERE
    DIAS = 0
  INTO
    :CONTADOR;

  IF (CONTADOR IS NULL) THEN
    CONTADOR = 0;

  /* NAO PODE HAVER MAIS DE 1 A VISTA */
  IF (CONTADOR > 1) THEN
    EXCEPTION AVISTA_SOMETEUM;

  /* SE HOUVER 1 PARCELA, VERIFICO SE EH A VISTA */
  IF (CONTADOR = 1) THEN
   BEGIN

     /* VERIFICO SE O DOCUMENTO FOI PREENCHIDO */
     IF (NEW.CODDOC_AVISTA IS NULL) THEN
       EXCEPTION FALTA_DOCAVISTA;

     /* VERIFICO SE ELE EH MESMO A VISTA */
     SELECT
       COUNT(*)
     FROM
       DOCUMENTOS
     WHERE
       CODIGO = NEW.CODDOC_AVISTA AND
       TIPO_PAG = 'A'
     INTO
       :CONTADOR;

     IF (CONTADOR IS NULL) THEN
       CONTADOR = 0;

     IF (CONTADOR = 0) THEN
       EXCEPTION FALTA_DOCAVISTA;

   END

  /* EXISTE PARCELA A PRAZO? */
  SELECT
    COUNT(*)
  FROM
    PARCELAS(NEW.CONDICAO)
  WHERE
    DIAS > 0
  INTO
    :CONTADOR;

  IF (CONTADOR IS NULL) THEN
    CONTADOR = 0;

  /* SE HOUVER 1 OU MAIS PARCELAS, VERIFICO SE EH A PRAZO */
  IF (CONTADOR >= 1) THEN
   BEGIN

     /* VERIFICO SE O DOCUMENTO FOI PREENCHIDO */
     IF (NEW.CODDOC_PRAZO IS NULL) THEN
       EXCEPTION FALTA_DOCPRAZO;

     /* VERIFICO SE ELE EH MESMO A VISTA */
     SELECT
       COUNT(*)
     FROM
       DOCUMENTOS
     WHERE
       CODIGO = NEW.CODDOC_PRAZO AND
       TIPO_PAG = 'V'
     INTO
       :CONTADOR;

     IF (CONTADOR IS NULL) THEN
       CONTADOR = 0;

     IF (CONTADOR = 0) THEN
       EXCEPTION FALTA_DOCPRAZO;

   END

END
^

SET TERM ; ^

SET TERM ^ ;

ALTER TRIGGER CONDPAG_BU0
ACTIVE BEFORE UPDATE POSITION 0
AS
DECLARE VARIABLE CONTADOR INTEGER;
BEGIN

  /* CONDICAO */
  IF ((NEW.CONDICAO IS NULL) OR (UDF_TRIM(NEW.CONDICAO) = '')) THEN
    EXCEPTION CONDICAO_ERRADA;

  IF (UDF_COPY(UDF_TRIM(NEW.CONDICAO), UDF_LEN(UDF_TRIM(NEW.CONDICAO)), 1) <> '/') THEN
    EXCEPTION CONDICAO_ERRADA;

  /* PREENCHO QUANTIDADE E PRAZO MEDIO */
  SELECT
    COUNT(DIAS),
    AVG(DIAS)
  FROM
    PARCELAS(NEW.CONDICAO)
  INTO
    NEW.QUANTIDADE,
    NEW.PRAZOMEDIO;

  IF (NEW.QUANTIDADE IS NULL) THEN
    EXCEPTION CONDICAO_ERRADA;

  /* EXISTE PARCELA A VISTA? */
  SELECT
    COUNT(*)
  FROM
    PARCELAS(NEW.CONDICAO)
  WHERE
    DIAS = 0
  INTO
    :CONTADOR;

  IF (CONTADOR IS NULL) THEN
    CONTADOR = 0;

  /* NAO PODE HAVER MAIS DE 1 A VISTA */
  IF (CONTADOR > 1) THEN
    EXCEPTION AVISTA_SOMETEUM;

  /* SE HOUVER 1 PARCELA, VERIFICO SE EH A VISTA */
  IF (CONTADOR = 1) THEN
   BEGIN

     /* VERIFICO SE O DOCUMENTO FOI PREENCHIDO */
     IF (NEW.CODDOC_AVISTA IS NULL) THEN
       EXCEPTION FALTA_DOCAVISTA;

     /* VERIFICO SE ELE EH MESMO A VISTA */
     SELECT
       COUNT(*)
     FROM
       DOCUMENTOS
     WHERE
       CODIGO = NEW.CODDOC_AVISTA AND
       TIPO_PAG = 'A'
     INTO
       :CONTADOR;

     IF (CONTADOR IS NULL) THEN
       CONTADOR = 0;

     IF (CONTADOR = 0) THEN
       EXCEPTION FALTA_DOCAVISTA;

   END

  /* EXISTE PARCELA A PRAZO? */
  SELECT
    COUNT(*)
  FROM
    PARCELAS(NEW.CONDICAO)
  WHERE
    DIAS > 0
  INTO
    :CONTADOR;

  IF (CONTADOR IS NULL) THEN
    CONTADOR = 0;

  /* SE HOUVER 1 OU MAIS PARCELAS, VERIFICO SE EH A PRAZO */
  IF (CONTADOR >= 1) THEN
   BEGIN

     /* VERIFICO SE O DOCUMENTO FOI PREENCHIDO */
     IF (NEW.CODDOC_PRAZO IS NULL) THEN
       EXCEPTION FALTA_DOCPRAZO;

     /* VERIFICO SE ELE EH MESMO A VISTA */
     SELECT
       COUNT(*)
     FROM
       DOCUMENTOS
     WHERE
       CODIGO = NEW.CODDOC_PRAZO AND
       TIPO_PAG = 'V'
     INTO
       :CONTADOR;

     IF (CONTADOR IS NULL) THEN
       CONTADOR = 0;

     IF (CONTADOR = 0) THEN
       EXCEPTION FALTA_DOCPRAZO;

   END

END
^

SET TERM ; ^

INSERT INTO SCRIPTVER(NUMERO, DATA) VALUES (366, CURRENT_TIMESTAMP);
COMMIT;

