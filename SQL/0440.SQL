/*
** BUG DO ENDERECO LONGO NA NOTA
*/

SET TERM ^ ;

ALTER PROCEDURE REL_NOTADUP (
    CODMOVIMENTO INTEGER)
RETURNS (
    MOVIMENTO INTEGER,
    NUMERO SMALLINT,
    DESCRICAO VARCHAR(40),
    DATACADAST TIMESTAMP,
    VALOR NUMERIC(9,2),
    DATAVENCIMENTO TIMESTAMP,
    CODIGO INTEGER,
    DOCUMENTO VARCHAR(30),
    CLI_NOME VARCHAR(40),
    CLI_LOGRADOURO VARCHAR(40),
    CLI_NUMERO INTEGER,
    CLI_COMPLEMENTO VARCHAR(40),
    CLI_BAIRRO VARCHAR(60),
    CLI_CEP VARCHAR(10),
    CLI_CIDADE VARCHAR(60),
    CLI_ESTADO VARCHAR(2),
    CLI_FONE VARCHAR(20),
    CLI_FAX VARCHAR(20),
    CLI_EMAIL VARCHAR(50),
    CLI_RGIE VARCHAR(20),
    CLI_CPFCGC VARCHAR(20),
    CODCLIENTE INTEGER,
    DATAPAGO TIMESTAMP,
    NOMEUSUARIO VARCHAR(30),
    DESCONTO NUMERIC(9,2),
    MULTA_JUROS NUMERIC(9,2),
    TOTAL_PAGO NUMERIC(9,2),
    INFODOC VARCHAR(50),
    EXTENSO VARCHAR(254),
    CODEMPRESA INTEGER,
    EMPRESA_NOME VARCHAR(40),
    EMPRESA_RAZAOSOCIAL VARCHAR(50),
    EMPRESA_CNPJ VARCHAR(20),
    EMPRESA_IE VARCHAR(20),
    EMPRESA_LOGRADOURO VARCHAR(60),
    EMPRESA_NUMERO INTEGER,
    EMPRESA_COMPLEMENTO VARCHAR(40),
    EMPRESA_BAIRRO VARCHAR(60),
    EMPRESA_CIDADE VARCHAR(60),
    EMPRESA_ESTADO CHAR(2),
    EMPRESA_CEP VARCHAR(9),
    EMPRESA_FONE VARCHAR(20),
    NOTA_NUMERO INTEGER,
    NOTA_DATAEMISSAO TIMESTAMP)
AS
DECLARE VARIABLE CODDOCUMENTO INTEGER;
DECLARE VARIABLE TEMP_PESSOAFISICA CHAR(1);
DECLARE VARIABLE TEMP_RAZAOSOCIAL VARCHAR(40);
DECLARE VARIABLE TEMP_IE VARCHAR(20);
DECLARE VARIABLE TEMP_CGC VARCHAR(20);
BEGIN
   FOR
   SELECT
     CODIGO,
     NUMERO,
     DESCRICAO,
     DATACADAST,
     VALOR,
     DATAVENCIMENTO,
     CODDOCUMENTO,
     DATAPAGO,
     NOMEUSUARIO,
     DESCONTO,
     MULTA_JUROS,
     TOTAL_PAGO,
     INFODOC,
     CODEMPRESA
   FROM
     PAGAMENTOS
   WHERE
     CODMOVIMENTO = :CODMOVIMENTO AND
     ES = 2
   INTO
     :CODIGO,
     :NUMERO,
     :DESCRICAO,
     :DATACADAST,
     :VALOR,
     :DATAVENCIMENTO,
     :CODDOCUMENTO,
     :DATAPAGO,
     :NOMEUSUARIO,
     :DESCONTO,
     :MULTA_JUROS,
     :TOTAL_PAGO,
     :INFODOC,
     :CODEMPRESA
   DO
   BEGIN
     MOVIMENTO = CODMOVIMENTO;
     /* PEGO O DOCUMENTO */
     SELECT
       DOCUMENTO
     FROM
       DOCUMENTOS
     WHERE
       CODIGO = :CODDOCUMENTO
     INTO
       :DOCUMENTO;

     /* CODIGO DO CLIENTE */
     SELECT
       CODCLIENTE,
       NOTA_NUMERO,
       NOTA_DATAEMISSAO
     FROM
       MOVIMENTOS
     WHERE
       CODIGO = :CODMOVIMENTO
     INTO
       :CODCLIENTE,
       :NOTA_NUMERO,
       :NOTA_DATAEMISSAO;

     /* DADOS DO CLIENTE */
     SELECT
       CL.NOME,
       UDF_LEFT(CL.RAZAOSOCIAL, 40),
       CL.PESSOAFISICA,
       CL.NUMERO,
       CL.COMPLEMENTO,
       CL.ESTADO,
       CL.FONE,
       CL.FAX,
       CL.EMAIL,
       CL.RG,
       CL.CPF,
       CL.IE,
       CL.CGC,
       UDF_LEFT(LO.LOGRADOURO, 40),
       BA.BAIRRO,
       CI.CIDADE,
       LO.CEP
     FROM
       CLIENTES CL
       LEFT JOIN LOGRADOUROS LO ON
         ( LO.CODIGO = CL.LOCALIZACAO AND
           LO.BAIRRO = CL.BAIRRO AND
           LO.CIDADE = CL.CIDADE AND
           LO.ESTADO = CL.ESTADO )
       LEFT JOIN BAIRROS BA ON
         ( BA.CODIGO = CL.BAIRRO AND
           BA.CIDADE = CL.CIDADE AND
           BA.ESTADO = CL.ESTADO )
       LEFT JOIN CIDADES CI ON
         ( CI.CODIGO = CL.CIDADE AND
           CI.ESTADO = CL.ESTADO )
     WHERE
       CL.CODIGO = :CODCLIENTE
     INTO
       :CLI_NOME,
       :TEMP_RAZAOSOCIAL,
       :TEMP_PESSOAFISICA,
       :CLI_NUMERO,
       :CLI_COMPLEMENTO,
       :CLI_ESTADO,
       :CLI_FONE,
       :CLI_FAX,
       :CLI_EMAIL,
       :CLI_RGIE,
       :CLI_CPFCGC,
       :TEMP_IE,
       :TEMP_CGC,
       :CLI_LOGRADOURO,
       :CLI_BAIRRO,
       :CLI_CIDADE,
       :CLI_CEP;
     IF ( TEMP_PESSOAFISICA = 'J' ) THEN
      BEGIN
       CLI_NOME   = TEMP_RAZAOSOCIAL;
       CLI_RGIE   = TEMP_IE;
       CLI_CPFCGC = TEMP_CGC;
      END
     /* DADOS DA EMPRESA */
     SELECT
       CL.NOME,
       CL.RAZAOSOCIAL,
       CL.CGC,
       CL.IE,
       CL.LOGRADOURO,
       CL.NUMERO,
       CL.COMPLEMENTO,
       CL.BAIRRO,
       CL.CIDADE,
       CL.ESTADO,
       CL.CEP,
       CL.FONE
     FROM
       SISCONFIG SI
       JOIN REL_CLIENTES CL ON
         (SI.CODCLIENTE = CL.CODIGO)
     WHERE
       SI.CODIGO = :CODEMPRESA
     INTO
       :EMPRESA_NOME,
       :EMPRESA_RAZAOSOCIAL,
       :EMPRESA_CNPJ,
       :EMPRESA_IE,
       :EMPRESA_LOGRADOURO,
       :EMPRESA_NUMERO,
       :EMPRESA_COMPLEMENTO,
       :EMPRESA_BAIRRO,
       :EMPRESA_CIDADE,
       :EMPRESA_ESTADO,
       :EMPRESA_CEP,
       :EMPRESA_FONE;
     SELECT
       EXTENSO
     FROM
       MOEDAEXTENSO(
          CAST(:TOTAL_PAGO AS DOUBLE PRECISION),
          :CODEMPRESA
       )
     INTO
       :EXTENSO;

     /* A VISTA */
     IF (UDF_LEFT(DOCUMENTO, 7) = 'A VISTA') THEN
       DATAVENCIMENTO = NULL;

     SUSPEND;
   END
END
^

SET TERM ; ^

INSERT INTO SCRIPTVER(NUMERO, DATA) VALUES (440, CURRENT_TIMESTAMP);
COMMIT;
