/*
** BUG DO ESTORNO DE O.S.
*/

SET TERM ^ ;

ALTER PROCEDURE ESTORNO (
    CODMOVIMENTO INTEGER,
    USUARIOESTORNO VARCHAR(30))
RETURNS (
    RE_MOVIMENTO INTEGER)
AS
DECLARE VARIABLE STATUS VARCHAR(30);
BEGIN

  RE_MOVIMENTO = 0;
  BEGIN

    IF ((USUARIOESTORNO IS NULL) OR (UDF_TRIM(USUARIOESTORNO) = '')) THEN
      USUARIOESTORNO = USER;

    /* STATUS ATUAL */
    SELECT
      STATUS
    FROM
      MOVIMENTOS
    WHERE
      CODIGO = :CODMOVIMENTO
    INTO
      :STATUS;

    /* MARCO COMO CANCELADO */
    UPDATE
      MOVIMENTOS
    SET
      TIPO = 9,
      USUARIOESTORNO = :USUARIOESTORNO,
      DATAESTORNO = CURRENT_TIMESTAMP,
      OLD_STATUS = UDF_LEFT(:STATUS, 20)
    WHERE
      CODIGO = :CODMOVIMENTO;

    WHEN ANY DO RE_MOVIMENTO = 1;

  END

END
^

SET TERM ; ^

INSERT INTO SCRIPTVER(NUMERO, DATA) VALUES (421, CURRENT_TIMESTAMP);
COMMIT;
