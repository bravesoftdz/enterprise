/*
** SISTEMA DE TROCA DE MENSAGENS
*/

SET TERM ^ ;

ALTER PROCEDURE REINICIAR (
    ROTINA INTEGER)
AS
DECLARE VARIABLE CODCLIENTE1 INTEGER;
DECLARE VARIABLE CODCLIENTE2 INTEGER;
BEGIN

  /* DETERMINO A ROTINA */
  IF (ROTINA IS NULL) THEN
    ROTINA = 0;

  /* LIMPAR TUDO */
  IF (ROTINA = 0) THEN
   BEGIN

     /* SEQUENCIA */
     DELETE FROM
       ITSEQUENCIA;

     /* PAGAMENTOS */
     UPDATE
       PAGAMENTOS
     SET PAGO = 0;

     DELETE FROM
       COMISSOES;

     DELETE FROM
       PAGAMENTOS;

     UPDATE
       SEQUENCIA
     SET
       SEQUENCIA = 1
     WHERE
       TABELA = 'PAGAMENTOS';

     /* ESTOQUE */
     UPDATE
       INDIVIDUAIS
     SET
       VENDIDO = 'N';

     DELETE FROM
       INDIVIDUAIS;

     DELETE FROM
       TEMPITENS;

     UPDATE
       SEQUENCIA
     SET
       SEQUENCIA = 1
     WHERE
       TABELA = 'INDIVIDUAIS';

     UPDATE
       SEQUENCIA
     SET
       SEQUENCIA = 1
     WHERE
       TABELA = 'TEMPITENS';

     /* PRODUTOS */
     DELETE FROM
       VARIACAO_VALOR;

     DELETE FROM
       CONTRATOS;

     DELETE FROM
       COMPOSICAO;

     DELETE FROM
       PRODUTOS;

     UPDATE
       SEQUENCIA
     SET
       SEQUENCIA = 10000
     WHERE
       TABELA = 'PRODUTOS';

     /* MOVIMENTOS */
     DELETE FROM
       OS_VENDER;

     DELETE FROM
       MOVIMENTOS;

     UPDATE
       SEQUENCIA
     SET
       SEQUENCIA = 10000
     WHERE
       TABELA = 'MOVIMENTOS';

     /* EMPRESAS */
     DELETE FROM
       TRANSFERENCIAS;

     DELETE FROM
       SISCONFIG
     WHERE
       CODIGO > 1;

     /* CLIENTES */
     SELECT
       SI.CODCLIENTE,
       SI.CODCLIENTE_PADRAO
     FROM
       SISCONFIG SI
     WHERE
       SI.CODIGO = 1
     INTO
       :CODCLIENTE1,
       :CODCLIENTE2;

     DELETE FROM
       CLIENTES
     WHERE
       CODIGO NOT IN (:CODCLIENTE1, :CODCLIENTE2);

     UPDATE
       SEQUENCIA
     SET
       SEQUENCIA = UDF_MAX(:CODCLIENTE1, :CODCLIENTE2) + 1
     WHERE
       TABELA = 'CLIENTES';

     UPDATE
       CLIENTES
     SET
       NOMEUSER = 'SYSDBA',
       SENHAWEB = 'MORAIS77',
       DESCONTO = 0,
       FINANCEIRO = 'S',
       ESTORNO = 'S',
       TROCAVENDEDOR = 'S',
       INTERNET = 'S',
       MUDAEMPRESA = 'S',
       COMISSAO = 0,
       TIPO = 'A',
       RECEBIMENTO = 'S',
       CUSTO = 'S',
       SEQUENCIAS = 'S',
       RECALCULO = 'S',
       COMPRAS = 'S',
       TRANSFERENCIA = 'S',
       RELATORIOS = 'S',
       VENDADIRETA = 'S',
       TECNICOLOGIN = 'N',
       FECHAMENTO = 'S'
     WHERE
       CODIGO = :CODCLIENTE1;


   END

END
^

SET TERM ; ^

DROP TABLE MENSAGENS;

COMMIT WORK;

CREATE TABLE MENSAGENS (
    CODMENSAGEM INTEIRO_VALIDO NOT NULL,
    CODUSUARIO INTEIRO_VALIDO,
    CODDESTINO INTEIRO_VALIDO,
    NOVA SIMNAO,
    RESPOSTA SIMNAO,
    CODORIGINAL INTEIRO,
    DATA_ENVIO DATA_HOJE,
    ASSUNTO STR60_VALIDO,
    CORPO STR254,
    RECEBIDA SIMNAO,
    DATA_RECEBIMENTO DATA);

ALTER TABLE MENSAGENS
ADD CONSTRAINT PK_MENSAGENS
PRIMARY KEY (CODMENSAGEM);

ALTER TABLE MENSAGENS
ADD CONSTRAINT MENSAGENS_FK01
FOREIGN KEY (CODUSUARIO)
REFERENCES CLIENTES(CODIGO)
ON UPDATE CASCADE;

ALTER TABLE MENSAGENS
ADD CONSTRAINT MENSAGENS_FK02
FOREIGN KEY (CODDESTINO)
REFERENCES CLIENTES(CODIGO)
ON UPDATE CASCADE;

GRANT ALL ON MENSAGENS TO PUBLIC;

INSERT INTO SEQUENCIA VALUES (61, 'MENSAGENS', 1);

INSERT INTO SCRIPTVER(NUMERO, DATA) VALUES (340, CURRENT_TIMESTAMP);
COMMIT;

