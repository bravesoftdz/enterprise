/*
** VERIFICACAO DO CLIENTE
*/

SET TERM ^ ;

CREATE PROCEDURE VERIFICA_PESSOA (
    CODCLIENTE INTEGER,
    CODEMPRESA INTEGER)
RETURNS (
    BLOQUEIO CHAR(1),
    MENSAGEM VARCHAR(80))
AS
DECLARE VARIABLE TIPO_BLOQUEIO CHAR(1);
DECLARE VARIABLE TIPO_IMPEDIMENTO CHAR(1);
DECLARE VARIABLE LIMITE NUMERIC(15,3);
DECLARE VARIABLE ABERTOS NUMERIC(15,3);
DECLARE VARIABLE DATAABERTO TIMESTAMP;
DECLARE VARIABLE BLOQUEIO_DIAS INTEGER;
BEGIN

     /* BLOQUEIOS DO CLIENTE */
     SELECT
       CL.TIPO_BLOQUEIO,
       CL.TIPO_IMPEDIMENTO,
       CL.LIMITECREDITO
     FROM
       CLIENTES CL
     WHERE
       CL.CODIGO = :CODCLIENTE
     INTO
       :TIPO_BLOQUEIO,
       :TIPO_IMPEDIMENTO,
       :LIMITE;

     /* CLIENTE É BLOQUEADO? */
     IF (TIPO_BLOQUEIO = 'B') THEN
      BEGIN
        MENSAGEM = 'PESSOA PERMANENTEMENTE BLOQUEADA. IMPOSSÍVEL CONTINUAR.';
        BLOQUEIO = 'S';
        SUSPEND;
      END

     /* DEVO CALCULAR OUTROS BLOQUEIOS? */
     IF (TIPO_BLOQUEIO = 'A') THEN
      BEGIN

        /* TEM IMPEDIMENTOS? */
        IF (TIPO_IMPEDIMENTO <> 'N') THEN
         BEGIN
           MENSAGEM = 'PESSOA TEM IMPEDIMENTOS NO CADASTRO.';
           BLOQUEIO = 'A';
           SUSPEND;
         END

        /* LIMITE DE CRÉDITO NO FINANCEIRO */
        SELECT
          SUM(PA.VALOR)
        FROM
          PAGAMENTOS PA
        WHERE
          PA.ES = 2 AND
          PA.PAGO = 0 AND
          PA.CODCLIENTE = :CODCLIENTE AND
          PA.CODEMPRESA = :CODEMPRESA
        INTO
          :ABERTOS;

        IF (LIMITE < ABERTOS) THEN
         BEGIN
           MENSAGEM = 'FINANCEIRO A PRAZO EXCEDE O LIMITE DE CRÉDITO DA PESSOA';
           BLOQUEIO = 'A';
           SUSPEND;
         END

        /* DATA EM ABERTO */
        SELECT
          MIN(PA.DATAVENCIMENTO)
        FROM
          PAGAMENTOS PA
        WHERE
          PA.ES = 2 AND
          PA.PAGO = 0 AND
          PA.CODCLIENTE = :CODCLIENTE AND
          PA.CODEMPRESA = :CODEMPRESA
        INTO
          :DATAABERTO;

        SELECT
          SISCONFIG.BLOQUEIO_DIAS
        FROM
          SISCONFIG
        WHERE
          SISCONFIG.CODIGO = :CODEMPRESA
        INTO
          :BLOQUEIO_DIAS;

        IF (BLOQUEIO_DIAS < (CURRENT_DATE - CAST(DATAABERTO AS DATE))) THEN
         BEGIN
           MENSAGEM = 'PESSOA TEM DÉBITOS ANTERIORES NO FINANCEIRO';
           BLOQUEIO = 'A';
           SUSPEND;
         END

      END

     MENSAGEM = '';
     BLOQUEIO = 'N';
     SUSPEND;

END
^

SET TERM ; ^

GRANT EXECUTE ON PROCEDURE VERIFICA_PESSOA TO PUBLIC;

INSERT INTO SCRIPTVER(NUMERO, DATA) VALUES (400, CURRENT_TIMESTAMP);
COMMIT;
