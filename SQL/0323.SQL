/*
** USUARIO NA BAIXA
*/

SET TERM ^ ;

ALTER TRIGGER PAGAMENTOS_BU0
ACTIVE BEFORE UPDATE POSITION 0
AS
  DECLARE VARIABLE ULTIMO     INTEGER;
  DECLARE VARIABLE SALDO      NUMERIC(9, 2);
  DECLARE VARIABLE SALDONOVO  NUMERIC(9, 2);
BEGIN

  /* CARREGO AS OPCOES DO DOCUMENTO */
  SELECT
    TIPO_PAG,
    TIPO_DOC
  FROM
    DOCUMENTOS
  WHERE
    CODIGO = NEW.CODDOCUMENTO
  INTO
    NEW.TIPO_PAG,
    NEW.TIPO_DOC;

  /* FOI ESTORNADO? */
  IF (NEW.ESTORNO_CODUSUARIO IS NOT NULL) THEN
   BEGIN
     SELECT
       NOMEUSER
     FROM
       CLIENTES
     WHERE
       CODIGO = NEW.ESTORNO_CODUSUARIO
     INTO
       NEW.ESTORNO_NOMEUSER;
   END

  /* ESTA PAGO? */
  IF ((OLD.PAGO = 0) AND (NEW.PAGO = 1)) THEN
   BEGIN
    /* DESCUBRO O SALDO ANTERIOR */
    SELECT
      MAX(CODLANCTO)
    FROM
      PAGAMENTOS
    WHERE
      CODCONTA = NEW.CODCONTA AND
      CODEMPRESA = NEW.CODEMPRESA
    INTO
      :ULTIMO;
    IF (ULTIMO IS NOT NULL) THEN
     BEGIN
       SELECT
         SALDOATU
       FROM
         PAGAMENTOS
       WHERE
         CODLANCTO = :ULTIMO
       INTO
         :SALDO;
     END ELSE SALDO = 0;
    /* PEGO O NUMERO DESTE LANCAMENTO */
    SELECT
      SEQUENCIA
    FROM
      SEQ_OBTER('LANCTO')
    INTO
      :ULTIMO;
    /* GRAVO OS VALORES CORRETOS */
    NEW.SALDOANT = SALDO;
    IF (NEW.ES = 1) THEN
      SALDONOVO = SALDO - NEW.TOTAL_PAGO;
    IF (NEW.ES = 2) THEN
      SALDONOVO = SALDO + NEW.TOTAL_PAGO;
    NEW.SALDOATU = SALDONOVO;
    NEW.DATAPAGO = 'NOW';
    NEW.CODLANCTO = ULTIMO;
   END
END
^

SET TERM ; ^

INSERT INTO SCRIPTVER(NUMERO, DATA) VALUES (323, CURRENT_TIMESTAMP);
COMMIT;

