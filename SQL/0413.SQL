/*
** TRIM DA SERIE
*/

SET TERM ^ ;

ALTER PROCEDURE REL_NOTAPRO (
    CODMOVIMENTO INTEGER)
RETURNS (
    CODIGO INTEGER,
    BARRA CHAR(13),
    DESCRICAO1 VARCHAR(60),
    DESCRICAO2 VARCHAR(80),
    SERIE VARCHAR(20),
    SERIE2 VARCHAR(20),
    VALOR_VENDA NUMERIC(14,3),
    ICMS_VENDA NUMERIC(14,4),
    DESCONTO NUMERIC(14,3),
    QUANTIDADE NUMERIC(14,3),
    VALOR_PAGO NUMERIC(14,3),
    VALOR_ICMS NUMERIC(14,3),
    SITTRIBU CHAR(3),
    UNIDADE CHAR(2),
    VALOR_ITEM NUMERIC(14,3),
    IPI NUMERIC(14,4),
    LINHA VARCHAR(20),
    OPERADORA VARCHAR(40),
    PLANO VARCHAR(40),
    CONTRATO VARCHAR(10),
    VOUCHER VARCHAR(10),
    TIPOATIVACAO CHAR(1),
    CLASSFISCAL VARCHAR(20),
    PESO NUMERIC(9,3))
AS
DECLARE VARIABLE ES INTEGER;
DECLARE VARIABLE XIPI CHAR(1);
DECLARE VARIABLE FATURA_CAIXAS CHAR(1);
DECLARE VARIABLE CAIXA_ITENS INTEGER;
DECLARE VARIABLE N INTEGER;
BEGIN
  /* VERIFICO SE EH COMPRA OU VENDA */
  SELECT
    ES
  FROM
    MOVIMENTOS
  WHERE
    CODIGO = :CODMOVIMENTO
  INTO
    :ES;

  IF (ES = 1) THEN
   BEGIN

     /* COMPRA */
     FOR
     SELECT
       TI.CODPRODUTO,
       PO.BARRA,
       PO.DESCRICAO,
       PO.UNIDADE,
       PO.CLASSFISCAL,
       PO.PESO,
       'N/F',
       TI.VALOR_UNITARIO,
       TI.ICMSCOMPRA,
       TI.DESCONTO,
       TI.SITTRIBU,
       TI.QUANTIDADE,
       TI.VALOR_TOTAL,
       TI.VALOR_ICMSCOMPRA
     FROM
       TEMPITENS TI
       LEFT JOIN PRODUTOS PO ON
         ( PO.CODIGO = TI.CODPRODUTO )
     WHERE
       TI.CODMOVIMENTO = :CODMOVIMENTO
     INTO
       :CODIGO,
       :BARRA,
       :DESCRICAO1,
       :UNIDADE,
       :CLASSFISCAL,
       :PESO,
       :SERIE,
       :VALOR_VENDA,
       :ICMS_VENDA,
       :DESCONTO,
       :SITTRIBU,
       :QUANTIDADE,
       :VALOR_PAGO,
       :VALOR_ICMS
     DO
     BEGIN

       IF (SERIE <> 'N/F') THEN
        BEGIN
          N = UDF_LEN(UDF_TRIM(DESCRICAO1));
          IF (N > 40) THEN
            DESCRICAO2 = UDF_COPY(DESCRICAO1, 1, 40) || ' ' || UDF_TRIM(SERIE);
          ELSE
            DESCRICAO2 = UDF_TRIM(DESCRICAO1) || ' ' || UDF_TRIM(SERIE);
        END ELSE
          DESCRICAO2 = DESCRICAO1;

       VALOR_ITEM = VALOR_VENDA - DESCONTO;
       PESO = PESO * QUANTIDADE;
       LINHA = NULL;
       OPERADORA = NULL;
       PLANO = NULL;
       CONTRATO = NULL;
       VOUCHER = NULL;
       TIPOATIVACAO = NULL;
       SUSPEND;

    END

   END ELSE
   BEGIN

     /* VERIFICO SE CORTO IPI */
     SELECT
       NA.IPI
     FROM
       NATUOPER NA
       JOIN MOVIMENTOS MO ON
         (MO.NOTA_CODNATUOPER = NA.CODIGO)
     WHERE
       MO.CODIGO = :CODMOVIMENTO
     INTO
       :XIPI;

     /* VERIFICO SE VAI FATURAR POR CAIXAS */
     SELECT
       HG.FATURA_CAIXAS
     FROM
       HISTORICOPAG HG
       JOIN MOVIMENTOS MO ON
         (MO.CODHISTORICOPAG = HG.CODIGO)
     WHERE
       MO.CODIGO = :CODMOVIMENTO
     INTO
       :FATURA_CAIXAS;

     /* VENDA */
     FOR
     SELECT
       ID.CODPRODUTO,
       ID.BARRA,
       PO.DESCRICAO,
       PO.UNIDADE,
       PO.CLASSFISCAL,
       PO.PESO,
       PO.CAIXA_ITENS,
       ID.SERIE,
       ID.SERIE2,
       ID.VALOR_VENDA,
       ID.ICMSVENDA,
       ID.DESCONTO,
       TI.SITTRIBU,
       TI.IPI,
       ID.NUMERO_FONE,
       ID.CONTRATO,
       ID.VOUCHER,
       ID.TIPOATIVACAO,
       OP.NOME,
       PL.NOME,
       SUM(ID.QUANTIDADE),
       SUM(ID.VALOR_PAGO),
       SUM(ID.VALOR_ICMS)
     FROM
       INDIVIDUAIS ID
       LEFT JOIN PRODUTOS PO ON
         ( PO.CODIGO = ID.CODPRODUTO )
       LEFT JOIN TEMPITENS TI ON
         ( TI.CODMOVIMENTO = ID.CODMOVENTRADA AND
           TI.CODPRODUTO   = ID.CODPRODUTO    AND
           TI.CODIGO       = ID.CODITEM )
       LEFT JOIN OPERADORAS OP ON
         ( OP.CODIGO = ID.CODOPERADORA )
       LEFT JOIN PLANOS PL ON
         ( PL.CODIGO = ID.CODPLANO AND
           PL.CODOPERADORA = ID.CODOPERADORA )
     WHERE
       ID.CODMOVSAIDA = :CODMOVIMENTO AND
       ID.VENDIDO = 'S' AND
       ID.PS = 'P'
     GROUP BY
       ID.CODPRODUTO,
       ID.BARRA,
       PO.DESCRICAO,
       PO.UNIDADE,
       PO.CLASSFISCAL,
       PO.PESO,
       PO.CAIXA_ITENS,
       ID.SERIE,
       ID.SERIE2,
       ID.VALOR_VENDA,
       ID.ICMSVENDA,
       ID.DESCONTO,
       TI.SITTRIBU,
       TI.IPI,
       ID.NUMERO_FONE,
       ID.CONTRATO,
       ID.VOUCHER,
       ID.TIPOATIVACAO,
       OP.NOME,
       PL.NOME
     INTO
       :CODIGO,
       :BARRA,
       :DESCRICAO1,
       :UNIDADE,
       :CLASSFISCAL,
       :PESO,
       :CAIXA_ITENS,
       :SERIE,
       :SERIE2,
       :VALOR_VENDA,
       :ICMS_VENDA,
       :DESCONTO,
       :SITTRIBU,
       :IPI,
       :LINHA,
       :CONTRATO,
       :VOUCHER,
       :TIPOATIVACAO,
       :OPERADORA,
       :PLANO,
       :QUANTIDADE,
       :VALOR_PAGO,
       :VALOR_ICMS
     DO
     BEGIN

       /* VERIFICO SE O SERIE2 CONTEM DADOS E SERIE NAO, MANDO SERIE2 */
       IF ((UDF_TRIM(SERIE) = 'N/F') OR (UDF_TRIM(SERIE) = '')) THEN
         IF (UDF_TRIM(SERIE2) > '') THEN
           SERIE = SERIE2;

       IF (SERIE <> 'N/F') THEN
        BEGIN
          N = UDF_LEN(UDF_TRIM(DESCRICAO1));
          IF (N > 40) THEN
            DESCRICAO2 = UDF_COPY(DESCRICAO1, 1, 40) || ' ' || UDF_TRIM(SERIE);
          ELSE
            DESCRICAO2 = UDF_TRIM(DESCRICAO1) || ' ' || UDF_TRIM(SERIE);
        END ELSE
          DESCRICAO2 = DESCRICAO1;

       IF (CAIXA_ITENS IS NULL) THEN
         CAIXA_ITENS = 0;

       IF ((FATURA_CAIXAS = 'S') AND
          (QUANTIDADE >= CAIXA_ITENS)) THEN
        BEGIN
          UNIDADE = 'CX';
          QUANTIDADE = QUANTIDADE / CAIXA_ITENS;
          VALOR_VENDA = VALOR_VENDA * CAIXA_ITENS;
          DESCONTO = DESCONTO * CAIXA_ITENS;
        END

       VALOR_ITEM = VALOR_VENDA - DESCONTO;
       PESO = PESO * QUANTIDADE;

       IF (XIPI = 'N') THEN
         IPI = NULL;

       SUSPEND;

     END
   END
END
^

SET TERM ; ^

INSERT INTO SCRIPTVER(NUMERO, DATA) VALUES (413, CURRENT_TIMESTAMP);
COMMIT;
