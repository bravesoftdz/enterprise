/*
** EXTENSO NOS PAGAMENTOS
*/

ALTER TABLE PAGAMENTOS ADD EXTENSO STR254;

SET TERM ^ ;

ALTER TRIGGER PAGAMENTOS_BI100
ACTIVE BEFORE INSERT POSITION 100
AS
DECLARE VARIABLE DIA_FLUXO INTEGER;
BEGIN

  /* VALOR POR EXTENSO */
  EXECUTE PROCEDURE MOEDAEXTENSO NEW.TOTAL_PAGO, NEW.CODEMPRESA
    RETURNING_VALUES NEW.EXTENSO;

  /* ANALISE DE DATAS - CADASTRO */
  IF (NEW.DATACADAST IS NOT NULL) THEN
    EXECUTE PROCEDURE ANALISE_DATA(NEW.DATACADAST)
      RETURNING_VALUES
        NEW.CAD_DATA_FLUXO,
        DIA_FLUXO,
        NEW.CAD_SEMANA_FLUXO,
        NEW.CAD_MES_FLUXO,
        NEW.CAD_BIMESTRE_FLUXO,
        NEW.CAD_TRIMESTRE_FLUXO,
        NEW.CAD_QUADRIMESTRE_FLUXO,
        NEW.CAD_SEMESTRE_FLUXO,
        NEW.CAD_ANO_FLUXO,
        NEW.CAD_STR_SEMANA_FLUXO,
        NEW.CAD_STR_MES_FLUXO,
        NEW.CAD_STR_BIMESTRE_FLUXO,
        NEW.CAD_STR_TRIMESTRE_FLUXO,
        NEW.CAD_STR_QUADRIMESTRE_FLUXO,
        NEW.CAD_STR_SEMESTRE_FLUXO;

  /* ANALISE DE DATAS - VENCIMENTO */
  IF (NEW.DATAVENCIMENTO IS NOT NULL) THEN
    EXECUTE PROCEDURE ANALISE_DATA(NEW.DATAVENCIMENTO)
      RETURNING_VALUES
        NEW.VEN_DATA_FLUXO,
        DIA_FLUXO,
        NEW.VEN_SEMANA_FLUXO,
        NEW.VEN_MES_FLUXO,
        NEW.VEN_BIMESTRE_FLUXO,
        NEW.VEN_TRIMESTRE_FLUXO,
        NEW.VEN_QUADRIMESTRE_FLUXO,
        NEW.VEN_SEMESTRE_FLUXO,
        NEW.VEN_ANO_FLUXO,
        NEW.VEN_STR_SEMANA_FLUXO,
        NEW.VEN_STR_MES_FLUXO,
        NEW.VEN_STR_BIMESTRE_FLUXO,
        NEW.VEN_STR_TRIMESTRE_FLUXO,
        NEW.VEN_STR_QUADRIMESTRE_FLUXO,
        NEW.VEN_STR_SEMESTRE_FLUXO;

  /* ANALISE DE DATAS - PAGAMENTO */
  IF (NEW.DATAPAGO IS NOT NULL) THEN
    EXECUTE PROCEDURE ANALISE_DATA(NEW.DATAPAGO)
      RETURNING_VALUES
        NEW.PAG_DATA_FLUXO,
        DIA_FLUXO,
        NEW.PAG_SEMANA_FLUXO,
        NEW.PAG_MES_FLUXO,
        NEW.PAG_BIMESTRE_FLUXO,
        NEW.PAG_TRIMESTRE_FLUXO,
        NEW.PAG_QUADRIMESTRE_FLUXO,
        NEW.PAG_SEMESTRE_FLUXO,
        NEW.PAG_ANO_FLUXO,
        NEW.PAG_STR_SEMANA_FLUXO,
        NEW.PAG_STR_MES_FLUXO,
        NEW.PAG_STR_BIMESTRE_FLUXO,
        NEW.PAG_STR_TRIMESTRE_FLUXO,
        NEW.PAG_STR_QUADRIMESTRE_FLUXO,
        NEW.PAG_STR_SEMESTRE_FLUXO;

END
^

SET TERM ; ^

SET TERM ^ ;

ALTER TRIGGER PAGAMENTOS_BU100
ACTIVE BEFORE UPDATE POSITION 100
AS
DECLARE VARIABLE DIA_FLUXO INTEGER;
BEGIN

  /* STATUS */
  IF (NEW.PAGO = 0) THEN
   BEGIN
     IF (NEW.ES IN (3, 4)) THEN
       NEW.STATUS = 'LIXEIRA';
     ELSE
       NEW.STATUS = 'ABERTO';
   END ELSE
     NEW.STATUS = 'PAGO';

  /* ANALISE DE VALORES */
  IF (NEW.ES = 1) THEN
    NEW.VALOR_FLUXO = (NEW.TOTAL_PAGO * -1);

  IF (NEW.ES = 2) THEN
    NEW.VALOR_FLUXO = NEW.TOTAL_PAGO;

  /* VALOR POR EXTENSO */
  EXECUTE PROCEDURE MOEDAEXTENSO NEW.TOTAL_PAGO, NEW.CODEMPRESA
    RETURNING_VALUES NEW.EXTENSO;

  /* ANALISE DE DATAS - CADASTRO */
  IF (NEW.DATACADAST IS NOT NULL) THEN
    EXECUTE PROCEDURE ANALISE_DATA(NEW.DATACADAST)
      RETURNING_VALUES
        NEW.CAD_DATA_FLUXO,
        DIA_FLUXO,
        NEW.CAD_SEMANA_FLUXO,
        NEW.CAD_MES_FLUXO,
        NEW.CAD_BIMESTRE_FLUXO,
        NEW.CAD_TRIMESTRE_FLUXO,
        NEW.CAD_QUADRIMESTRE_FLUXO,
        NEW.CAD_SEMESTRE_FLUXO,
        NEW.CAD_ANO_FLUXO,
        NEW.CAD_STR_SEMANA_FLUXO,
        NEW.CAD_STR_MES_FLUXO,
        NEW.CAD_STR_BIMESTRE_FLUXO,
        NEW.CAD_STR_TRIMESTRE_FLUXO,
        NEW.CAD_STR_QUADRIMESTRE_FLUXO,
        NEW.CAD_STR_SEMESTRE_FLUXO;

  /* ANALISE DE DATAS - VENCIMENTO */
  IF (NEW.DATAVENCIMENTO IS NOT NULL) THEN
    EXECUTE PROCEDURE ANALISE_DATA(NEW.DATAVENCIMENTO)
      RETURNING_VALUES
        NEW.VEN_DATA_FLUXO,
        DIA_FLUXO,
        NEW.VEN_SEMANA_FLUXO,
        NEW.VEN_MES_FLUXO,
        NEW.VEN_BIMESTRE_FLUXO,
        NEW.VEN_TRIMESTRE_FLUXO,
        NEW.VEN_QUADRIMESTRE_FLUXO,
        NEW.VEN_SEMESTRE_FLUXO,
        NEW.VEN_ANO_FLUXO,
        NEW.VEN_STR_SEMANA_FLUXO,
        NEW.VEN_STR_MES_FLUXO,
        NEW.VEN_STR_BIMESTRE_FLUXO,
        NEW.VEN_STR_TRIMESTRE_FLUXO,
        NEW.VEN_STR_QUADRIMESTRE_FLUXO,
        NEW.VEN_STR_SEMESTRE_FLUXO;

  /* ANALISE DE DATAS - PAGAMENTO */
  IF (NEW.DATAPAGO IS NOT NULL) THEN
    EXECUTE PROCEDURE ANALISE_DATA(NEW.DATAPAGO)
      RETURNING_VALUES
        NEW.PAG_DATA_FLUXO,
        DIA_FLUXO,
        NEW.PAG_SEMANA_FLUXO,
        NEW.PAG_MES_FLUXO,
        NEW.PAG_BIMESTRE_FLUXO,
        NEW.PAG_TRIMESTRE_FLUXO,
        NEW.PAG_QUADRIMESTRE_FLUXO,
        NEW.PAG_SEMESTRE_FLUXO,
        NEW.PAG_ANO_FLUXO,
        NEW.PAG_STR_SEMANA_FLUXO,
        NEW.PAG_STR_MES_FLUXO,
        NEW.PAG_STR_BIMESTRE_FLUXO,
        NEW.PAG_STR_TRIMESTRE_FLUXO,
        NEW.PAG_STR_QUADRIMESTRE_FLUXO,
        NEW.PAG_STR_SEMESTRE_FLUXO;

END
^

SET TERM ; ^

UPDATE
  PAGAMENTOS
SET
  ARQUIVO = NULL
WHERE
  PAGO = 0;

INSERT INTO SCRIPTVER(NUMERO, DATA) VALUES (368, CURRENT_TIMESTAMP);
COMMIT;

